---
phase: 04-additional-games
plan: 09
type: execute
wave: 4
depends_on: [04-01, 04-02, 04-05, 04-06]
files_modified:
  - src/lib/game/poker/handlers.ts
  - server.js
autonomous: true

must_haves:
  truths:
    - "Poker server handlers process all player actions (fold, check, call, raise, all-in)"
    - "Blinds are posted automatically at the start of each hand"
    - "Community cards dealt correctly (flop=3, turn=1, river=1)"
    - "Showdown evaluates hands and distributes pots (including side pots)"
    - "Dealer button rotates after each hand"
    - "Buy-in converts to in-game chips at start, chips convert back on game end"
    - "Disconnected players auto-fold"
  artifacts:
    - path: "src/lib/game/poker/handlers.ts"
      provides: "Poker Socket.IO event handlers"
      exports: ["registerPokerHandlers"]
  key_links:
    - from: "src/lib/game/poker/handlers.ts"
      to: "src/lib/game/poker/state-machine.ts"
      via: "Uses applyPokerAction for game logic"
      pattern: "import.*state-machine"
    - from: "src/lib/game/poker/handlers.ts"
      to: "src/lib/game/poker/pot-calculator.ts"
      via: "Uses calculateSidePots and distributePots"
      pattern: "import.*pot-calculator"
    - from: "server.js"
      to: "src/lib/game/poker/handlers.ts"
      via: "Registers poker handlers on socket connection"
      pattern: "registerPokerHandlers"
---

<objective>
Build Poker server handlers that orchestrate the full Texas Hold'em game loop: blind posting, dealing, betting rounds, showdown with side pots, and chip-to-balance conversion.

Purpose: The server handlers bridge the poker state machine and pot calculator into the real-time multiplayer infrastructure, handling the complex lifecycle of poker hands including buy-in/cashout, rebuys, and host-controlled game ending.
Output: Poker server handlers fully integrated into server.js.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-additional-games/04-CONTEXT.md
@src/lib/game/poker/state-machine.ts
@src/lib/game/poker/pot-calculator.ts
@src/lib/game/poker/hand-evaluator.ts
@server.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Poker server handlers</name>
  <files>
    src/lib/game/poker/handlers.ts
  </files>
  <action>
    1. Create `src/lib/game/poker/handlers.ts`:
       - Export `registerPokerHandlers(socket, io, roomManager, prisma)` function
       - Import state machine, pot calculator, hand evaluator, deck utilities, crypto-rng

       Socket.IO events to handle:
       - `poker:action` — { roomId, action: 'fold' | 'check' | 'call' | 'raise' | 'all_in', amount? }
         a. Get room, validate it's poker gameType
         b. Apply action via applyPokerAction
         c. Check if betting round is complete (all bets equalized)
         d. If round complete, advance phase (deal community cards or go to showdown)
         e. Auto-post blinds when new hand starts
         f. Emit `game:state-update` with state (IMPORTANT: filter hole cards — only send a player's own hole cards, not opponents')
         g. On showdown: evaluate hands, calculate side pots, distribute winnings
         h. Emit `poker:showdown` with all revealed cards and hand names

       - `poker:rebuy` — { roomId, amount }
         a. Only allowed between hands (phase 'hand_end')
         b. Only if room settings allow rebuys
         c. Debit from user's balance/escrow, add to player's chip stack
         d. Track total buy-ins per player

       - `poker:end-game` — { roomId } — Host ends the game session
         a. Only host can trigger
         b. Convert remaining chips back to balance proportionally to buy-in rate
         c. Create transactions for each player: net gain/loss
         d. Release escrows
         e. Transition room to 'ended'

       - `poker:sit-out` — { roomId } — Player sits out (skips hands but keeps seat)
       - `poker:sit-in` — { roomId } — Player returns from sitting out

       Auto-fold timer:
       - When it's a player's turn, start a 30-second action timer
       - If timer expires, auto-fold the player
       - Store timer in Map similar to existing turnTimers
       - Clear timer when player acts

       State broadcasting rules (CRITICAL for poker):
       - NEVER send other players' hole cards in `game:state-update`
       - Each player receives personalized state: their own holeCards + empty arrays for others
       - Only reveal all cards during `poker:showdown` event
       - Spectators see no hole cards until showdown
  </action>
  <verify>
    - TypeScript compiles without errors
    - Handler functions are properly structured
  </verify>
  <done>Poker handlers handle all actions, auto-fold timer, hole card filtering, showdown with side pots, rebuy flow, and host-controlled game ending</done>
</task>

<task type="auto">
  <name>Task 2: Wire Poker handlers into server.js</name>
  <files>
    server.js
  </files>
  <action>
    1. In `server.js`:
       - Import `registerPokerHandlers` from poker handlers
       - In `io.on('connection')`, call `registerPokerHandlers(socket, io, roomManager, prisma)`
       - Update `game:start` handler for poker gameType:
         - Create shuffled deck via createDeck + shuffleDeck (CSPRNG)
         - Convert buy-in to chips: each player starts with chips equal to their bet amount (buy-in)
         - Use createPokerState(players, settings, deck) from poker state-machine
         - Store poker-specific settings: blinds, escalation, rebuys from room.pokerSettings
         - Auto-post blinds for first hand
         - Start action timer for first player to act
         - Emit personalized state to each player (filter hole cards)

       - Update room creation to accept poker settings:
         - startingBlinds, blindEscalation, blindInterval, allowRebuys, rebuyLimit, minBuyIn, maxBuyIn
         - Store in room.pokerSettings

       - Handle poker-specific disconnect:
         - If player disconnects during a hand, mark as disconnected
         - Auto-fold on their turn
         - If between hands, mark as sitting out
         - If all remaining players disconnect, end game

    2. Helper function for personalized state emission:
       ```javascript
       function emitPokerState(io, roomId, room) {
         const state = room.gameState
         // For each player socket in the room
         const sockets = io.sockets.adapter.rooms.get(roomId)
         if (!sockets) return
         for (const socketId of sockets) {
           const s = io.sockets.sockets.get(socketId)
           if (!s) continue
           const personalizedState = {
             ...state,
             players: state.players.map(p => ({
               ...p,
               holeCards: p.userId === s.data.userId ? p.holeCards : (state.phase === 'showdown' ? p.holeCards : [])
             }))
           }
           s.emit('game:state-update', { state: personalizedState, roomId })
         }
       }
       ```
  </action>
  <verify>
    - `npm run build` succeeds
    - Server starts without errors
    - Existing Kniffel and Blackjack games still work
  </verify>
  <done>Poker handlers registered in server.js, game:start creates poker state with buy-in chip conversion, personalized state emission filters hole cards, action timers set up</done>
</task>

</tasks>

<verification>
- Poker room can be created with blind/rebuy settings
- Game start posts blinds and deals hole cards
- Player actions (fold/check/call/raise/all-in) processed correctly
- Showdown evaluates hands and distributes pots
- Side pots work for all-in scenarios
- Hole cards hidden from other players
- Auto-fold timer kicks in on timeout
- Host can end game and chips convert back to balance
- npm run build succeeds
</verification>

<success_criteria>
- Complete poker server loop: blinds -> deal -> betting rounds -> showdown
- Personalized state emission (hole cards filtered)
- Side pot calculation via pot-calculator.ts
- Buy-in/cashout chip conversion
- Rebuy flow between hands
- Auto-fold timer (30s)
- Host-controlled game ending
- Escrow integration for bet rooms
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-09-SUMMARY.md`
</output>
