---
phase: 04-additional-games
plan: 07
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - src/lib/game/blackjack/handlers.ts
  - server.js
  - src/components/blackjack/BlackjackTable.tsx
  - src/components/blackjack/DealerHand.tsx
  - src/components/blackjack/PlayerHand.tsx
  - src/components/blackjack/ActionButtons.tsx
  - src/app/game/[roomId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Player can create and join a Blackjack room"
    - "Cards are dealt after all players place bets"
    - "Player can hit, stand, double, split, and surrender"
    - "Dealer plays automatically after all players finish"
    - "Blackjack pays 3:2, wins pay 1:1, pushes return bet"
    - "Cards display as SVG with flip animations on deal"
    - "Multiple players can play at the same table against dealer"
  artifacts:
    - path: "src/lib/game/blackjack/handlers.ts"
      provides: "Blackjack Socket.IO event handlers"
      exports: ["registerBlackjackHandlers"]
    - path: "src/components/blackjack/BlackjackTable.tsx"
      provides: "Main Blackjack game board component"
    - path: "src/components/blackjack/DealerHand.tsx"
      provides: "Dealer cards display with hidden card"
    - path: "src/components/blackjack/PlayerHand.tsx"
      provides: "Player hand display supporting splits"
    - path: "src/components/blackjack/ActionButtons.tsx"
      provides: "Hit/Stand/Double/Split/Surrender action bar"
  key_links:
    - from: "src/lib/game/blackjack/handlers.ts"
      to: "src/lib/game/blackjack/state-machine.ts"
      via: "Uses applyBlackjackAction for game logic"
      pattern: "import.*state-machine"
    - from: "server.js"
      to: "src/lib/game/blackjack/handlers.ts"
      via: "Registers blackjack handlers on socket connection"
      pattern: "registerBlackjackHandlers"
    - from: "src/app/game/[roomId]/page.tsx"
      to: "src/components/blackjack/BlackjackTable.tsx"
      via: "Renders BlackjackTable when gameType is 'blackjack'"
      pattern: "BlackjackTable"
---

<objective>
Build the complete Blackjack game integration: server handlers, UI components, and wire into existing infrastructure.

Purpose: Make Blackjack fully playable — from room creation to dealing cards to settlement — with casino-quality card rendering.
Output: Working Blackjack game with server handlers, felt table UI, animated cards, and action buttons.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-additional-games/04-CONTEXT.md
@src/lib/game/blackjack/state-machine.ts
@src/components/casino/Card.tsx
@src/components/casino/FeltTable.tsx
@server.js
@src/app/game/[roomId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Blackjack server handlers and wire into server.js</name>
  <files>
    src/lib/game/blackjack/handlers.ts
    server.js
  </files>
  <action>
    1. Create `src/lib/game/blackjack/handlers.ts`:
       - Export `registerBlackjackHandlers(socket, io, roomManager, prisma)` function
       - Handles these Socket.IO events:
         - `blackjack:place-bet` — { roomId, amount } — Player places bet for current round
         - `blackjack:action` — { roomId, action: 'hit' | 'stand' | 'double' | 'split' | 'insurance' | 'surrender' }
         - `blackjack:next-round` — { roomId } — Start next round (host or auto after settlement)
       - Each handler:
         a. Get room from roomManager
         b. Apply action via applyBlackjackAction from state-machine.ts
         c. If Error, return error to callback
         d. Update room.gameState
         e. Emit `game:state-update` to room
         f. Handle auto-dealer-play after all players finish (stand/bust/blackjack)
       - Handle escrow integration: when game starts, lock PENDING escrows; on settlement, calculate payouts
       - For bet rooms: each round's bet comes from in-game chips (already escrowed at room join)
       - Emit events for animations: `blackjack:card-dealt`, `blackjack:dealer-reveal`

    2. In `server.js`:
       - Import `registerBlackjackHandlers` from handlers.ts
       - In `io.on('connection')`, call `registerBlackjackHandlers(socket, io, roomManager, prisma)`
       - Update `game:start` handler for blackjack gameType:
         - Use `createBlackjackState` instead of `createInitialState`
         - Import from blackjack state-machine
         - Pass shuffled deck (using CSPRNG) into initial state
         - Set room.status to 'playing'
       - Ensure existing Kniffel handlers are unaffected (they already check gameType via phase/action type)
  </action>
  <verify>
    - `npm run build` succeeds
    - Server starts without errors
    - Kniffel games still work (regression check)
  </verify>
  <done>Blackjack server handlers registered, game:start creates blackjack state, socket events wired for blackjack actions</done>
</task>

<task type="auto">
  <name>Task 2: Build Blackjack UI components</name>
  <files>
    src/components/blackjack/BlackjackTable.tsx
    src/components/blackjack/DealerHand.tsx
    src/components/blackjack/PlayerHand.tsx
    src/components/blackjack/ActionButtons.tsx
    src/app/game/[roomId]/page.tsx
  </files>
  <action>
    1. Create `src/components/blackjack/BlackjackTable.tsx`:
       - Props: { gameState: BlackjackGameState; roomId: string; currentUserId: string; socket: Socket; isBetRoom?: boolean; betAmount?: number }
       - Layout: FeltTable wrapper, dealer hand at top, player hands at bottom
       - Show "Einsatz setzen" phase with bet input when in betting phase
       - Display chip amounts and current bet per player
       - Show hand values (e.g., "17", "Soft 19", "BUST")
       - Display "Blackjack!" overlay when player has natural blackjack
       - Show settlement results: Win/Lose/Push badges per hand
       - Include PotDisplay for bet rooms
       - Include GameChat integration

    2. Create `src/components/blackjack/DealerHand.tsx`:
       - Props: { cards: Card[]; hidden: boolean; handValue: number; phase: string }
       - Display dealer cards horizontally at top center
       - First card face-down during player turns (`hidden: true`)
       - Flip animation when revealing (transition from hidden to visible)
       - Show hand value when revealed
       - Show "Dealer zieht" label when dealer is hitting

    3. Create `src/components/blackjack/PlayerHand.tsx`:
       - Props: { hand: PlayerHand; isActive: boolean; playerName: string; isCurrentUser: boolean }
       - Display cards fanned horizontally
       - Show hand value with soft/hard indicator
       - Highlight active hand (golden border when it's this hand's turn)
       - Support split display: two hands side by side
       - Show bet amount below hand
       - Show doubled indicator when doubled down
       - Visual states: playing (normal), stood (dimmed), busted (red overlay), blackjack (gold glow), surrendered (strikethrough)

    4. Create `src/components/blackjack/ActionButtons.tsx`:
       - Props: { availableActions: string[]; onAction: (action: string) => void; disabled: boolean; currentBet: number; balance: number }
       - Row of action buttons: Ziehen (Hit), Halten (Stand), Verdoppeln (Double), Teilen (Split), Versicherung (Insurance), Aufgeben (Surrender)
       - Only show buttons for actions that are currently available
       - Disable when not player's turn
       - Verdoppeln shows the double amount
       - Responsive: stack on mobile, row on desktop

    5. In `src/app/game/[roomId]/page.tsx`:
       - Import BlackjackTable
       - Replace blackjack placeholder with: `<BlackjackTable gameState={...} roomId={...} currentUserId={...} socket={...} />`
       - Pass isBetRoom and betAmount props
       - Handle blackjack-specific socket events for card animations
  </action>
  <verify>
    - `npm run build` succeeds
    - Blackjack game board renders when gameType is 'blackjack'
    - Card components display correctly
  </verify>
  <done>BlackjackTable renders full game with dealer/player hands, action buttons show available moves, cards display with SVG and flip animations, game room page routes blackjack games to BlackjackTable</done>
</task>

</tasks>

<verification>
- Blackjack room can be created from lobby
- Cards deal with animation after bets placed
- All actions (hit, stand, double, split, surrender) work
- Dealer auto-plays after all players finish
- Settlement shows win/lose/push correctly
- Kniffel games are unaffected
- npm run build succeeds
</verification>

<success_criteria>
- Complete Blackjack game playable from lobby to settlement
- Server handlers use blackjack state machine (not inline logic)
- Cards render as SVG with flip animations
- Felt table provides casino aesthetic
- Action buttons show only valid actions
- Multiplayer: multiple players see each other's hands and play independently
- Escrow/payout integration for bet rooms
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-07-SUMMARY.md`
</output>
