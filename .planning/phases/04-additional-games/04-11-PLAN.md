---
phase: 04-additional-games
plan: 11
type: execute
wave: 6
depends_on: [04-07, 04-08, 04-10]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can play Texas Hold'em Poker with other players including blinds, raises, and all-in"
    - "User can play Blackjack solo against the house"
    - "User can play Blackjack with other players at multiplayer table"
    - "User can play Roulette solo against the house"
    - "User can play Roulette with other players at multiplayer table"
    - "All game outcomes use server-side cryptographic random number generation"
    - "Betting works correctly for all games with proper escrow and payout"
  artifacts: []
  key_links: []
---

<objective>
Full Phase 4 verification checkpoint. Verify all three games are playable end-to-end with betting integration.

Purpose: Ensure all Phase 4 success criteria are met before marking the phase complete.
Output: Verification results and any gap issues identified.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated verification of all games</name>
  <files></files>
  <action>
    Run the following verification checks:

    1. **Build check:** `npm run build` — must succeed with no errors
    2. **Test suites:** `npm test` — all tests pass:
       - Blackjack state machine tests
       - Roulette state machine and bet validator tests
       - Poker state machine, hand evaluator, and pot calculator tests
       - Existing Kniffel tests still pass
    3. **Type check:** Verify all new files compile without TypeScript errors
    4. **Server start:** Server starts without errors (check import resolution)
    5. **Game type registration:** Verify all three game handler modules are imported and registered

    6. **CSPRNG verification (CRITICAL — Success Criterion 6):**
       a. Run: `grep -r "Math.random" src/lib/game/blackjack/ src/lib/game/roulette/ src/lib/game/poker/ server.js --include="*.ts" --include="*.js"` — must return ZERO results
       b. Run: `grep -r "randomInt\|randomBytes\|crypto-rng\|node:crypto" src/lib/game/blackjack/ src/lib/game/roulette/ src/lib/game/poker/ server.js --include="*.ts" --include="*.js"` — must show usage in:
          - Blackjack: deck shuffling uses `randomInt` from `node:crypto` (or `crypto-rng.ts` wrapper)
          - Roulette: winning number generation uses `randomInt(0, 37)` from `node:crypto`
          - Poker: deck shuffling uses `randomInt` from `node:crypto` (or `crypto-rng.ts` wrapper)
          - server.js: existing `rollDice` import from `crypto-rng.js` remains
       c. Verify the existing `src/lib/game/crypto-rng.ts` exports are used or that `randomInt` from `node:crypto` is imported directly
       d. If ANY file uses `Math.random()` for game outcomes, this is a BLOCKER — fix before proceeding

    Check each Phase 4 success criterion:
    1. Poker: state machine handles blinds, betting rounds, showdown with side pots
    2. Blackjack solo: single player can play against dealer
    3. Blackjack multiplayer: multiple players independently play against dealer
    4. Roulette solo: single player can bet and spin
    5. Roulette multiplayer: multiple players bet on same spin
    6. CSPRNG: all deck shuffles and roulette spins use node:crypto (verified by step 6 above)
    7. Escrow: bet room flow works for all game types

    Document any gaps found.
  </action>
  <verify>
    - All automated checks pass
    - All test suites green
    - Build succeeds
    - CSPRNG grep confirms: zero `Math.random` in game handlers, `randomInt`/`crypto-rng` present in all three games
  </verify>
  <done>All automated verifications pass, CSPRNG usage confirmed in all game handlers (no Math.random), gaps documented if any</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Three complete casino games: Blackjack, Roulette, and Texas Hold'em Poker, each with full UI, server handlers, and betting integration.</what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Open browser to http://localhost:3000

    **Blackjack verification:**
    a. Go to lobby, create a Blackjack room (select Blackjack as game type)
    b. Open second browser/incognito, join the room
    c. Both players ready up, host starts game
    d. Place bets, verify cards deal with animation
    e. Test Hit, Stand, Double Down actions
    f. Verify dealer plays automatically after all players finish
    g. Check win/lose/push settlement is correct

    **Roulette verification:**
    a. Create a Roulette room
    b. Place various bet types on the grid (straight, split, red/black, dozen)
    c. Spin the wheel, verify animation
    d. Check payouts are correct
    e. Verify result history updates

    **Poker verification:**
    a. Create a Poker room with 2+ players
    b. Verify blinds are posted automatically
    c. Test fold, check, call, raise actions
    d. Verify community cards deal (flop/turn/river)
    e. Check that opponent's hole cards are hidden
    f. Play to showdown, verify hand evaluation

    **Betting verification:**
    a. Create a bet room for each game type
    b. Verify escrow deduction on join
    c. Play a game to completion
    d. Verify payout distribution

    **Regression:**
    a. Create a Kniffel room, play a quick game
    b. Verify Kniffel still works correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all games work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Full Phase 4 success criteria from ROADMAP.md:
1. User can play Texas Hold'em Poker with other players including blinds, raises, and all-in
2. User can play Blackjack solo against the house
3. User can play Blackjack with other players at multiplayer table
4. User can play Roulette solo against the house
5. User can play Roulette with other players at multiplayer table
6. All game outcomes use server-side cryptographic random number generation
7. Betting works correctly for all games with proper escrow and payout
</verification>

<success_criteria>
- All 7 Phase 4 success criteria verified
- All test suites pass
- Build succeeds
- Human verification approved for all three games
- Kniffel regression passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-11-SUMMARY.md`
</output>
