---
phase: 04-additional-games
plan: 08
type: execute
wave: 4
depends_on: [04-01, 04-02, 04-04]
files_modified:
  - src/lib/game/roulette/handlers.ts
  - server.js
  - src/components/roulette/RouletteTable.tsx
  - src/components/roulette/RouletteWheel.tsx
  - src/components/roulette/BettingGrid.tsx
  - src/components/roulette/ResultHistory.tsx
  - src/app/game/[roomId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Player can create and join a Roulette room"
    - "Players can place bets on the betting grid (all bet types)"
    - "Roulette wheel spins with animated ball landing on winning number"
    - "Payouts calculated correctly for all bet types"
    - "Result history shows last 10-20 spins with hot/cold indicators"
    - "Multiplayer: all players bet on same spin, see each other's bets"
  artifacts:
    - path: "src/lib/game/roulette/handlers.ts"
      provides: "Roulette Socket.IO event handlers"
      exports: ["registerRouletteHandlers"]
    - path: "src/components/roulette/RouletteTable.tsx"
      provides: "Main roulette game board"
    - path: "src/components/roulette/RouletteWheel.tsx"
      provides: "Animated 2D roulette wheel (top-down)"
    - path: "src/components/roulette/BettingGrid.tsx"
      provides: "Number grid with clickable bet zones"
    - path: "src/components/roulette/ResultHistory.tsx"
      provides: "Last 10-20 spin results with hot/cold indicators"
  key_links:
    - from: "src/lib/game/roulette/handlers.ts"
      to: "src/lib/game/roulette/state-machine.ts"
      via: "Uses applyRouletteAction for game logic"
      pattern: "import.*state-machine"
    - from: "server.js"
      to: "src/lib/game/roulette/handlers.ts"
      via: "Registers roulette handlers on socket connection"
      pattern: "registerRouletteHandlers"
    - from: "src/components/roulette/BettingGrid.tsx"
      to: "src/lib/game/roulette/bet-validator.ts"
      via: "Client-side bet validation before sending to server"
      pattern: "import.*bet-validator"
---

<objective>
Build the complete Roulette game integration: server handlers, animated wheel, betting grid UI, and wire into existing infrastructure.

Purpose: Make Roulette fully playable with European rules, immersive wheel animation, and full bet type support.
Output: Working Roulette game with animated wheel, clickable betting grid, result history, and multiplayer simultaneous betting.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-additional-games/04-CONTEXT.md
@src/lib/game/roulette/state-machine.ts
@src/lib/game/roulette/bet-validator.ts
@src/lib/game/roulette/wheel.ts
@src/components/casino/FeltTable.tsx
@src/components/casino/ChipStack.tsx
@server.js
@src/app/game/[roomId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Roulette server handlers and wire into server.js</name>
  <files>
    src/lib/game/roulette/handlers.ts
    server.js
  </files>
  <action>
    1. Create `src/lib/game/roulette/handlers.ts`:
       - Export `registerRouletteHandlers(socket, io, roomManager, prisma)` function
       - Handles these Socket.IO events:
         - `roulette:place-bet` — { roomId, betType, numbers, amount } — Place a bet on the grid
         - `roulette:remove-bet` — { roomId, betIndex } — Remove a placed bet
         - `roulette:spin` — { roomId } — Host triggers spin (or auto when timer expires)
         - `roulette:next-round` — { roomId } — Ready for next round
       - Each handler:
         a. Get room from roomManager
         b. Validate via bet-validator.ts on server side
         c. Apply action via applyRouletteAction
         d. Update room.gameState
         e. Emit `game:state-update` to room
       - For SPIN action: generate winning number via `randomInt(0, 37)` from node:crypto (0-36)
       - Emit `roulette:spin-result` with { winningNumber, playerPayouts } after settlement
       - Handle spin timer: if room has spinTimerSec > 0, start timer on round start, auto-spin on expiry
       - Track spin timers in Map similar to turn timers
       - Handle escrow: for bet rooms, bets come from escrowed chips

    2. In `server.js`:
       - Import `registerRouletteHandlers`
       - In `io.on('connection')`, call `registerRouletteHandlers(socket, io, roomManager, prisma)`
       - Update `game:start` handler for roulette gameType:
         - Use `createRouletteState` from roulette state-machine
         - Pass spin timer settings from room.rouletteSettings
         - Set initial phase to 'betting'
       - Store roulette-specific settings from room creation
  </action>
  <verify>
    - `npm run build` succeeds
    - Server starts without errors
    - Existing games still work
  </verify>
  <done>Roulette server handlers registered, spin uses CSPRNG, timer management for auto-spin, escrow integration</done>
</task>

<task type="auto">
  <name>Task 2: Build Roulette UI components</name>
  <files>
    src/components/roulette/RouletteTable.tsx
    src/components/roulette/RouletteWheel.tsx
    src/components/roulette/BettingGrid.tsx
    src/components/roulette/ResultHistory.tsx
    src/app/game/[roomId]/page.tsx
  </files>
  <action>
    1. Create `src/components/roulette/RouletteTable.tsx`:
       - Props: { gameState: RouletteGameState; roomId: string; currentUserId: string; socket: Socket; isBetRoom?: boolean }
       - Layout: FeltTable wrapper with wheel on left, betting grid on right (or stacked on mobile)
       - Show current phase: "Einsätze platzieren" (betting), "Kugel rollt..." (spinning), "Ergebnis" (settlement)
       - Display total bet amount per player
       - "Drehen" (Spin) button for host, or countdown timer display
       - Settlement overlay showing winning number and per-player results
       - ResultHistory at bottom

    2. Create `src/components/roulette/RouletteWheel.tsx`:
       - Props: { winningNumber?: number; isSpinning: boolean; onSpinComplete?: () => void }
       - 2D top-down circular wheel using SVG or CSS
       - 37 numbered segments in European wheel order (from wheel.ts EUROPEAN_WHEEL_ORDER)
       - Color segments: green (0), red, black following standard pattern
       - Spin animation: CSS rotation with ease-out deceleration
       - Ball animation: separate element orbiting the wheel, slows down to land on winning number
       - When spinning: wheel rotates, ball orbits with decreasing speed
       - When stopped: ball rests on winning number segment, highlight that segment
       - Size: responsive, min ~250px diameter

    3. Create `src/components/roulette/BettingGrid.tsx`:
       - Props: { onPlaceBet: (betType, numbers, amount) => void; onRemoveBet: (index) => void; playerBets: RouletteBet[]; allPlayerBets: Map<string, RouletteBet[]>; disabled: boolean; chipValue: number }
       - Standard roulette table layout:
         - Top: 0 (green, spans full height on left)
         - 3 columns × 12 rows = 36 numbers
         - Bottom row: 1st/2nd/3rd dozen
         - Side: column bets
         - Bottom: 1-18, Even, Red, Black, Odd, 19-36
       - Click number for straight bet
       - Click between numbers for split bet
       - Click row start for street bet
       - Click corner of 4 numbers for corner bet
       - Click outside zones for outside bets
       - Selected bet amount chip follows cursor on hover
       - Show placed bets as chip icons on the grid
       - Other players' bets shown as smaller/translucent chips with player color
       - Chip value selector: 1, 5, 25, 100, 500 chip denominations

    4. Create `src/components/roulette/ResultHistory.tsx`:
       - Props: { results: number[]; maxDisplay?: number }
       - Horizontal scrollable row of last 10-20 results
       - Each result: colored circle (red/black/green) with number
       - Hot numbers: numbers appearing more than expected (highlight)
       - Cold numbers: numbers not appearing recently (dim/blue tint)
       - Statistics summary: red vs black count, odd vs even count

    5. In `src/app/game/[roomId]/page.tsx`:
       - Import RouletteTable
       - Replace roulette placeholder with RouletteTable component
       - Pass gameState, roomId, currentUserId, socket, isBetRoom props
       - Handle roulette-specific socket events (roulette:spin-result for animation trigger)
  </action>
  <verify>
    - `npm run build` succeeds
    - Roulette table renders with wheel and betting grid
    - Wheel animation CSS works
  </verify>
  <done>RouletteTable renders complete game, wheel spins with ball animation, betting grid supports all bet types with click placement, result history shows colored numbers with hot/cold indicators</done>
</task>

</tasks>

<verification>
- Roulette room can be created from lobby
- Betting grid allows placing all bet types
- Wheel spins with animation and lands on winning number
- Payouts calculated correctly
- Result history updates after each spin
- Multiplayer: all players see each other's bets
- npm run build succeeds
</verification>

<success_criteria>
- Complete Roulette game playable from lobby to settlement
- All 13 bet types placeable via grid interaction
- 2D wheel animation with ball landing on correct number
- Hot/cold indicators in result history
- Host can manually trigger spin or use timer
- Multiplayer betting works simultaneously
- Escrow/payout integration for bet rooms
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-08-SUMMARY.md`
</output>
