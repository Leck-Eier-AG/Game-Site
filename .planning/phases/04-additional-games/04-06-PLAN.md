---
phase: 04-additional-games
plan: 06
type: tdd
wave: 3
depends_on: [04-05]
files_modified:
  - src/lib/game/poker/pot-calculator.ts
  - src/lib/game/poker/__tests__/pot-calculator.test.ts
autonomous: true

must_haves:
  truths:
    - "Side pots are created correctly when players go all-in with different stack sizes"
    - "Each pot tracks eligible players (only those who contributed enough)"
    - "Ties within side pots split evenly with remainder to first player"
    - "Total distributed equals total pot (no chips lost or created)"
    - "Single pot scenario works when no all-in occurs"
  artifacts:
    - path: "src/lib/game/poker/pot-calculator.ts"
      provides: "Poker pot and side pot calculation"
      exports: ["calculateSidePots", "distributePots", "Pot"]
    - path: "src/lib/game/poker/__tests__/pot-calculator.test.ts"
      provides: "Pot calculator test suite"
  key_links:
    - from: "src/lib/game/poker/pot-calculator.ts"
      to: "src/lib/game/poker/hand-evaluator.ts"
      via: "Uses hand evaluation for pot distribution"
      pattern: "import.*hand-evaluator"
---

<objective>
Build the Poker pot calculator with side pot support using TDD. Side pots are the most error-prone part of poker implementation.

Purpose: When players go all-in with different stack sizes, side pots must be created correctly with proper eligibility tracking. This is a separate TDD plan because pot calculation has many edge cases that benefit from thorough testing.
Output: Tested pot calculator handling all-in scenarios with 2-9 players.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-additional-games/04-RESEARCH.md
@src/lib/game/poker/state-machine.ts
@src/lib/game/poker/hand-evaluator.ts
</context>

<feature>
  <name>Poker Pot Calculator with Side Pots</name>
  <files>
    src/lib/game/poker/pot-calculator.ts
    src/lib/game/poker/__tests__/pot-calculator.test.ts
  </files>
  <behavior>
    Types:
    - Pot: { amount: number; eligiblePlayerIds: string[] }
    - PlayerContribution: { userId: string; amount: number; isFolded: boolean }

    Functions:
    - calculateSidePots(contributions: PlayerContribution[]): Pot[]
      Algorithm (from RESEARCH.md Pattern 4):
      1. Sort players by bet amount ascending
      2. For each distinct bet level, create a pot
      3. Each pot's amount = (bet - previous bet level) * number of players who bet at least that much
      4. Folded players contribute to pots but are NOT eligible to win
      5. Each pot tracks eligible (non-folded) players

    - distributePots(pots: Pot[], handRankings: Map<string, number>): Map<string, number>
      For each pot:
      1. Find the best hand among eligible players
      2. If tie, split evenly (remainder to first in tie)
      3. Return total winnings per player

    Test cases:
    - 2 players, no all-in: single pot, winner takes all
    - 2 players, one all-in: main pot at all-in level, excess returned
    - 3 players, one all-in with smallest stack:
      - Main pot: 3 × smallest = all eligible
      - Side pot: 2 × (medium - smallest) = two remaining eligible
    - 3 players, two all-in at different levels:
      - Main pot: 3 × smallest
      - Side pot 1: 2 × (medium - smallest)
      - Side pot 2: 1 × (largest - medium) — returned to single player
    - 4 players with varying stacks all-in (complex scenario)
    - Folded player contributions included in pot but NOT eligible to win
    - Tie in pot: split evenly, remainder to first
    - Total distributed = total contributed (conservation check)
    - Zero contribution player (folded preflop) has no pot
    - All players fold except one: winner takes pot
    - 9 players with 5 different all-in levels (stress test)
  </behavior>
  <implementation>
    1. Implement calculateSidePots using the proven algorithm from Research
    2. Implement distributePots using hand rankings from hand-evaluator
    3. Thorough TDD with conservation checks (total in = total out)
    4. Pure functions, no side effects
    5. Integer arithmetic only (no floating point)
  </implementation>
</feature>

<verification>
- `npm test -- --testPathPattern=pot-calculator` passes all tests
- Conservation: total distributed always equals total contributed
- Edge cases: all-fold, single all-in, multiple all-ins, ties
</verification>

<success_criteria>
- 15+ test cases covering 2-9 player scenarios
- Side pot calculation follows proven algorithm
- Conservation invariant holds for all test cases
- Folded players excluded from pot eligibility
- Ties handled correctly with even split
- Integer arithmetic throughout (no floating point)
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-06-SUMMARY.md`
</output>
