---
phase: 04-additional-games
plan: 04
type: tdd
wave: 2
depends_on: [04-01]
files_modified:
  - src/lib/game/roulette/state-machine.ts
  - src/lib/game/roulette/bet-validator.ts
  - src/lib/game/roulette/wheel.ts
  - src/lib/game/roulette/__tests__/state-machine.test.ts
  - src/lib/game/roulette/__tests__/bet-validator.test.ts
autonomous: true

must_haves:
  truths:
    - "Roulette state machine handles: betting -> spinning -> settlement -> round_end cycle"
    - "All European roulette bet types are supported (straight, split, street, corner, line, dozen, column, red/black, odd/even, high/low)"
    - "Bet validation correctly identifies valid number combinations for each bet type"
    - "Payouts are calculated correctly (35:1 straight, 17:1 split, etc.)"
    - "Winning number is generated server-side via CSPRNG"
    - "Result history tracks last 20 results"
  artifacts:
    - path: "src/lib/game/roulette/state-machine.ts"
      provides: "Roulette game state machine"
      exports: ["createRouletteState", "applyRouletteAction", "RouletteGameState", "RouletteAction"]
    - path: "src/lib/game/roulette/bet-validator.ts"
      provides: "Bet type validation and payout calculation"
      exports: ["validateBet", "calculateBetPayout", "ROULETTE_BETS", "getBetNumbers"]
    - path: "src/lib/game/roulette/wheel.ts"
      provides: "European wheel configuration and number properties"
      exports: ["WHEEL_NUMBERS", "getNumberColor", "getNumberProperties", "EUROPEAN_WHEEL_ORDER"]
  key_links:
    - from: "src/lib/game/roulette/state-machine.ts"
      to: "src/lib/game/roulette/bet-validator.ts"
      via: "Validates bets and calculates payouts"
      pattern: "import.*bet-validator"
    - from: "src/lib/game/roulette/state-machine.ts"
      to: "src/lib/game/roulette/wheel.ts"
      via: "Wheel configuration for number properties"
      pattern: "import.*wheel"
---

<objective>
Build the Roulette game state machine with comprehensive bet validation using TDD. Roulette is mechanically simpler than card games but requires extensive bet type support.

Purpose: European roulette with full bet range (inside + outside bets), simultaneous multiplayer betting, and CSPRNG number generation.
Output: Tested Roulette state machine, bet validator with all 13 bet types, and European wheel configuration.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-additional-games/04-CONTEXT.md
@.planning/phases/04-additional-games/04-RESEARCH.md
@src/lib/game/state-machine.ts
@src/lib/game/crypto-rng.ts
</context>

<feature>
  <name>Roulette State Machine and Bet Validator</name>
  <files>
    src/lib/game/roulette/wheel.ts
    src/lib/game/roulette/bet-validator.ts
    src/lib/game/roulette/state-machine.ts
    src/lib/game/roulette/__tests__/bet-validator.test.ts
    src/lib/game/roulette/__tests__/state-machine.test.ts
  </files>
  <behavior>
    **wheel.ts:**
    - European wheel order: [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26]
    - Number colors: 0=green, red=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36], rest=black
    - getNumberColor(n) -> 'red' | 'black' | 'green'
    - getNumberProperties(n) -> { color, isEven, isOdd, isLow, isHigh, dozen, column }
    - EUROPEAN_WHEEL_ORDER array for wheel rendering

    **bet-validator.ts:**
    - ROULETTE_BETS const: { straight: { count: 1, payout: 35 }, split: { count: 2, payout: 17 }, street: { count: 3, payout: 11 }, corner: { count: 4, payout: 8 }, line: { count: 6, payout: 5 }, dozen: { count: 12, payout: 2 }, column: { count: 12, payout: 2 }, red/black/odd/even/low/high: { count: 18, payout: 1 } }
    - validateBet(betType, numbers): boolean — check correct count and valid number combinations
      - straight: 1 number, 0-36
      - split: 2 adjacent numbers (horizontally or vertically on grid)
      - street: 3 numbers in a row (e.g., 1,2,3 or 4,5,6)
      - corner: 4 numbers forming square on grid
      - line: 6 numbers (two adjacent streets)
      - dozen: 12 numbers (1-12, 13-24, or 25-36)
      - column: 12 numbers (1st column: 1,4,7,...,34; 2nd: 2,5,8,...,35; 3rd: 3,6,9,...,36)
      - red/black/odd/even/low/high: no numbers needed (implicit from type)
    - calculateBetPayout(betType, betAmount, winningNumber): number — 0 if loss, betAmount * (payout + 1) if win
    - getBetNumbers(betType, identifier): number[] — generate number array for outside bets

    **state-machine.ts:**
    - RouletteGameState: { phase, players (RoulettePlayer[]), currentRound, winningNumber, resultHistory (last 20), spinTimerSec, isManualSpin }
    - RoulettePlayer: { userId, displayName, bets (RouletteBet[]), totalBetAmount, isConnected }
    - RouletteBet: { type, numbers, amount }
    - RouletteAction: 'PLACE_BET' | 'REMOVE_BET' | 'SPIN' | 'PLAYER_DISCONNECT'

    Game flow:
    1. Betting phase: all players place bets simultaneously (PLACE_BET adds bet, REMOVE_BET removes)
    2. Spin: host triggers (SPIN action) or timer expires. Winning number determined by CSPRNG (passed as action param: { type: 'SPIN', winningNumber })
    3. Settlement: calculate payouts for each player's bets
    4. Round end: update result history, ready for next round

    Test cases for bet-validator:
    - Each bet type validates correct number count
    - Split validates adjacency (horizontal: [1,2], vertical: [1,4])
    - Street validates rows ([1,2,3], [4,5,6], ..., [34,35,36])
    - Corner validates squares ([1,2,4,5], [2,3,5,6])
    - Line validates two adjacent streets ([1,2,3,4,5,6])
    - Dozen validates correct ranges (1-12, 13-24, 25-36)
    - Column validates correct columns
    - Outside bets (red/black/odd/even/low/high) don't need numbers
    - Payout calculations for each bet type
    - Zero (0) loses all outside bets
    - Straight bet on 0 wins at 35:1

    Test cases for state-machine:
    - Create state with 1-10 players
    - Place bet -> validates bet type and stores
    - Remove bet -> removes from player's bets
    - Spin -> transitions to settlement, sets winningNumber
    - Settlement calculates correct payouts per player
    - Multiple bets per player on same spin
    - Player disconnect -> auto-remove bets (or keep bets placed)
    - Round end updates result history (max 20)
    - Error on invalid actions (bet during spin, spin during betting by non-host)
  </behavior>
  <implementation>
    1. Build wheel.ts first — pure configuration data
    2. Build bet-validator.ts with TDD — validate each bet type, calculate payouts
    3. Build state-machine.ts with TDD — follows existing Kniffel pattern
    4. Pure functions throughout, CSPRNG number passed in action (not generated inside)
    5. No side effects, return Error objects not throw
  </implementation>
</feature>

<verification>
- `npm test -- --testPathPattern=roulette` passes all tests
- All 13 bet types validate correctly
- Payout calculations match European roulette rules
- State machine handles full spin cycle
</verification>

<success_criteria>
- 30+ test cases covering all bet types and state machine phases
- European wheel configuration is accurate
- Bet adjacency validation is correct for grid layout
- Payout calculations match standard European roulette
- State machine follows project patterns (pure functions, Error objects)
- Result history maintained (last 20 spins)
</success_criteria>

<output>
After completion, create `.planning/phases/04-additional-games/04-04-SUMMARY.md`
</output>
