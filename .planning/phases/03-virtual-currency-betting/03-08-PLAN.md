---
phase: 03-virtual-currency-betting
plan: 08
type: execute
wave: 4
depends_on: ["03-02", "03-06"]
files_modified:
  - server.js
  - src/components/betting/bet-confirmation.tsx
  - src/components/game/GameBoard.tsx
  - src/components/game/GameResults.tsx
  - src/components/betting/pot-display.tsx
  - src/components/betting/payout-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "Buy-in deducted from balance when joining a bet room"
    - "Buy-in refunded when leaving before game starts"
    - "Buy-in forfeited when leaving mid-game or AFK kicked"
    - "Game end distributes pot to winners according to payout ratios"
    - "Confirmation dialog appears when bet exceeds 25% of balance"
    - "Pot is always visible on game board during gameplay"
    - "Results screen shows detailed payout breakdown per player"
    - "Insufficient balance users can join as spectators"
  artifacts:
    - path: "server.js"
      provides: "Escrow-integrated room join/leave/game-end with balance operations"
      contains: "BetEscrow"
    - path: "src/components/betting/bet-confirmation.tsx"
      provides: "AlertDialog for high-stakes bet confirmation"
      exports: ["BetConfirmation"]
    - path: "src/components/betting/pot-display.tsx"
      provides: "Persistent pot display during gameplay"
      exports: ["PotDisplay"]
    - path: "src/components/betting/payout-breakdown.tsx"
      provides: "Detailed payout per player on results screen"
      exports: ["PayoutBreakdown"]
  key_links:
    - from: "server.js (room:join)"
      to: "prisma BetEscrow + Wallet"
      via: "Prisma transaction: debit balance, create PENDING escrow, log BET_PLACED"
      pattern: "betEscrow\\.create"
    - from: "server.js (game end)"
      to: "src/lib/wallet/payout.ts"
      via: "calculatePayouts for prize distribution"
      pattern: "calculatePayouts"
    - from: "src/components/betting/pot-display.tsx"
      to: "room state"
      via: "room.isBetRoom && room.betAmount * activePlayers"
      pattern: "totalPot"
---

<objective>
Escrow-integrated game lifecycle: buy-in on join, refund on pre-game leave, forfeit on mid-game leave, payout on game end.

Purpose: This is the core betting integration that connects the financial system to the game lifecycle. Buy-ins create escrow records, game completion triggers payout calculation, and all balance changes are ACID-safe with transaction logging. UI components show pot during play and payout breakdown at results.

Output: Full bet lifecycle in server.js, bet confirmation dialog, pot display component, payout breakdown component.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-02-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-06-SUMMARY.md
@server.js
@src/lib/wallet/payout.ts
@src/lib/wallet/escrow.ts
@src/components/game/GameBoard.tsx
@src/components/game/GameResults.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side escrow lifecycle (join buy-in, leave refund/forfeit, game end payout)</name>
  <files>server.js</files>
  <action>
Update `server.js` to integrate escrow and balance operations:

Import at top (same pattern as existing imports):
```javascript
import { creditBalance, debitBalance, getWalletWithUser, getSystemSettings } from './src/lib/wallet/transactions.js'
import { calculatePayouts } from './src/lib/wallet/payout.js'
import { canTransition } from './src/lib/wallet/escrow.js'
```

Also need Prisma for escrow operations (prisma is already imported).

1. **room:join handler update** - When joining a bet room:
   - Check if room.isBetRoom
   - If bet room:
     a. Fetch wallet: getWalletWithUser(userId)
     b. Check wallet.frozenAt === null (frozen can't bet)
     c. Check balance >= room.betAmount
     d. If insufficient balance: allow join as spectator (add to spectators, not players) with { spectator: true, reason: 'insufficient_balance' }
     e. If sufficient: inside Prisma transaction (Serializable):
        - Debit balance (type: BET_PLACED, description: `Einsatz: ${room.name}`)
        - Create BetEscrow record (status: PENDING, amount: room.betAmount)
     f. After transaction: emit balance:updated to user via `io.to('user:${userId}')`
   - If free room: join as before (no changes)

2. **room:leave handler update** - When leaving a bet room:
   - Check if room.isBetRoom and player was a bettor (not spectator)
   - Find BetEscrow for (roomId, userId)
   - If escrow status is PENDING (game hasn't started):
     a. Inside Prisma transaction:
        - Credit balance back (type: BET_REFUND, description: `Einsatz zurueck: ${room.name}`)
        - Update escrow status to RELEASED, set releasedAt
     b. Emit balance:updated to user
   - If escrow status is LOCKED (game in progress):
     a. Inside Prisma transaction:
        - Update escrow status to FORFEITED
        - Create Transaction (type: BET_FORFEIT, description: `Einsatz verfallen: ${room.name}`)
     b. Do NOT refund balance (already deducted)
     c. Emit balance:updated not needed (no balance change)

3. **game:start handler update** - When game starts:
   - For all bet rooms: update all PENDING escrows to LOCKED (set lockedAt = now())
   - Use Prisma updateMany: where { roomId, status: 'PENDING' }, data { status: 'LOCKED', lockedAt: new Date() }

4. **Game end handler update** (in game:choose-category and autoPlay where phase==='ended'):
   - After detecting game end in a bet room:
     a. Calculate total pot: count LOCKED escrows for room, sum amounts
     b. Build rankings from game results (use game state players sorted by score, detect ties)
     c. Call calculatePayouts(totalPot, rankings, room.payoutRatios)
     d. Inside Prisma transaction:
        - For each winner: creditBalance(userId, payoutAmount, 'GAME_WIN', `${room.name} gewonnen (${position}. Platz)`)
        - Update all escrows to RELEASED (set releasedAt)
     e. After transaction: emit balance:updated to each winner
     f. Include payout info in game:ended event: { payouts: Map<userId, { amount, position }> }

5. **AFK kick in bet rooms** - When kickPlayerAFK is called:
   - If bet room: forfeit escrow (same as leaving mid-game)
   - Update escrow to FORFEITED

6. **Helper: buildRankings(gameState)** function:
   - Sort players by total score descending
   - Detect ties (same score = same position)
   - Return FinalRanking[] array
   - Import calculateTotalScore from kniffel-rules

7. Add `payouts` field to room object to store payout results after game end (for results screen).

Note: All database operations (escrow, balance) happen OUTSIDE the in-memory room state updates. The pattern is:
1. Apply game state change (in-memory)
2. Perform database operations (escrow + balance)
3. Emit Socket.IO events AFTER database commits
  </action>
  <verify>
Server starts without errors. Create a bet room. Join with another user - verify balance deducted. Leave before start - verify balance refunded. Start game, leave mid-game - verify no refund. Complete game - verify winner gets payout.
  </verify>
  <done>Full escrow lifecycle works: buy-in on join, refund before start, forfeit mid-game, payout on end. All operations ACID-safe with transaction records. Balance events emitted after each operation.</done>
</task>

<task type="auto">
  <name>Task 2: Bet confirmation dialog, pot display, and payout breakdown UI</name>
  <files>src/components/betting/bet-confirmation.tsx, src/components/betting/pot-display.tsx, src/components/betting/payout-breakdown.tsx, src/components/game/GameBoard.tsx, src/components/game/GameResults.tsx</files>
  <action>
Create `src/components/betting/bet-confirmation.tsx`:
- Uses Radix AlertDialog (shadcn pattern - may need to add alert-dialog component: `npx shadcn@latest add alert-dialog`)
- Props: open, betAmount, currentBalance, onConfirm, onCancel
- Shows when bet exceeds 25% of current balance (percentage-based threshold per user decision)
- Content in German:
  - Title: "Hoher Einsatz"
  - Description: "Du setzt {betAmount} Chips ({percentage}% deines Guthabens). Bist du sicher?"
  - Cancel: "Abbrechen"
  - Confirm: "Einsatz bestaetigen"
- Integrate into the room join flow in lobby: when user clicks "Beitreten" on a bet room, check if betAmount > 0.25 * balance, show dialog if so

Create `src/components/betting/pot-display.tsx`:
- Per user decision: "Pot always visible on game board during gameplay"
- Displays: chip icon + "Pot: {amount} Chips" with amber/gold styling
- Props: totalPot (number), currencyName (string)
- Animated: number ticks up when new player joins
- Compact display suitable for game board header area
- Styling: bg-amber-500/10, text-amber-500, rounded-full pill shape

Create `src/components/betting/payout-breakdown.tsx`:
- Per user decision: "Results screen shows detailed payout breakdown per player"
- Props: payouts (array of { userId, displayName, position, amount }), currencyName
- Display: table/list format
  - Each row: position medal (gold/silver/bronze), displayName, "+{amount} Chips ({position}. Platz)"
  - Winner(s) highlighted
  - Tied positions shown with same medal
- Styling: green text for amounts, matching results screen aesthetic

Update `src/components/game/GameBoard.tsx`:
- Import PotDisplay
- If room.isBetRoom: render PotDisplay above the game area (between player list and dice scene)
- Calculate totalPot from room.betAmount * activePlayerCount

Update `src/components/game/GameResults.tsx`:
- Import PayoutBreakdown
- If game was a bet room and payouts exist:
  - Show PayoutBreakdown below the existing podium/rankings
  - Pass payout data from game:ended event
- If free room: show results as before (no payout section)
  </action>
  <verify>
`npx tsc --noEmit` passes. Create bet room, join with second player, verify pot display shows. Play game to completion, verify payout breakdown appears on results screen. Test confirmation dialog: join a bet room with bet > 25% of balance.
  </verify>
  <done>Bet confirmation dialog appears for high-stakes bets. Pot is visible on game board during play. Results screen shows payout breakdown with position and amount per player. Insufficient balance users see spectator option.</done>
</task>

</tasks>

<verification>
- Join bet room: balance deducted, escrow created (PENDING)
- Leave before start: full refund, escrow RELEASED
- Game starts: escrows transition to LOCKED
- Leave mid-game: escrow FORFEITED, no refund
- Game ends: pot distributed per payout ratios, escrows RELEASED
- Tied players split prize evenly
- Pot display visible on game board for bet rooms
- Payout breakdown visible on results screen
- Confirmation dialog for bets > 25% of balance
- Free rooms unaffected by all changes
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Complete bet lifecycle integrated into game flow. Buy-in on join, refund before start, forfeit mid-game, payout on end. Pot visible during play. Detailed payout on results. Confirmation for high stakes. All operations ACID-safe with transaction logging.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-08-SUMMARY.md`
</output>
