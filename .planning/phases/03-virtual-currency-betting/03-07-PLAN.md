---
phase: 03-virtual-currency-betting
plan: 07
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - src/app/(app)/wallet/page.tsx
  - src/components/wallet/balance-chart.tsx
  - src/components/wallet/transaction-list.tsx
  - src/components/wallet/claim-daily.tsx
  - src/components/wallet/transfer-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their full wallet page at /wallet"
    - "Wallet page shows balance graph over time as line chart"
    - "Transaction list is grouped by day with filter controls"
    - "Each transaction has descriptive text and colored amount"
    - "User can claim daily allowance via button on wallet page"
    - "User can send chips to another player from wallet page"
  artifacts:
    - path: "src/app/(app)/wallet/page.tsx"
      provides: "Full wallet page with chart, transactions, daily claim, and transfer"
      contains: "BalanceChart"
    - path: "src/components/wallet/balance-chart.tsx"
      provides: "Recharts line chart of balance over time"
      exports: ["BalanceChart"]
    - path: "src/components/wallet/transaction-list.tsx"
      provides: "Transaction history grouped by day with filters"
      exports: ["TransactionList"]
    - path: "src/components/wallet/claim-daily.tsx"
      provides: "Daily allowance claim button with status info"
      exports: ["ClaimDaily"]
    - path: "src/components/wallet/transfer-form.tsx"
      provides: "P2P transfer form with recipient search and amount input"
      exports: ["TransferForm"]
  key_links:
    - from: "src/components/wallet/balance-chart.tsx"
      to: "src/lib/actions/wallet.ts"
      via: "getBalanceChartData server action"
      pattern: "getBalanceChartData"
    - from: "src/components/wallet/claim-daily.tsx"
      to: "src/lib/actions/wallet.ts"
      via: "claimDaily server action"
      pattern: "claimDaily"
    - from: "src/components/wallet/transfer-form.tsx"
      to: "src/lib/actions/wallet.ts"
      via: "transferFunds server action"
      pattern: "transferFunds"
---

<objective>
Full wallet page with balance chart, transaction history, daily claim, and P2P transfers.

Purpose: Per user decisions, the wallet page is the financial hub: balance graph at top, transaction list grouped by day with filters, daily allowance claim button, and a transfer form. This is the "PayPal for the platform" experience.

Output: Wallet page at /wallet with all wallet features accessible from one page.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-03-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-04-SUMMARY.md
@src/lib/actions/wallet.ts
@src/lib/wallet/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wallet page layout with balance chart and daily claim</name>
  <files>src/app/(app)/wallet/page.tsx, src/components/wallet/balance-chart.tsx, src/components/wallet/claim-daily.tsx</files>
  <action>
Create `src/app/(app)/wallet/page.tsx`:
- Server component, fetch initial data: getWalletData(), getBalanceChartData(30), getTransactions({ limit: 50 })
- Page title: "Mein Guthaben" with large balance display at top (current balance + currency name)
- Layout: two-column on desktop (chart + claim on left, transactions on right), single column on mobile
- Sections:
  1. Balance header with large number and currency name
  2. BalanceChart component (left column top)
  3. ClaimDaily component (left column below chart)
  4. TransferForm component (left column below claim)
  5. TransactionList component (right column, full height)
- Dark theme: bg-zinc-950 page, bg-zinc-900 cards, matching existing admin pages
- Add "force-dynamic" export to prevent build-time DB queries

Create `src/components/wallet/balance-chart.tsx`:
- 'use client' component receiving data as props: { date: string, balance: number }[]
- Uses Recharts: ResponsiveContainer (height 250), LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip
- X-axis: dates formatted with date-fns format(new Date(date), 'dd.MM') for German locale
- Y-axis: balance values
- Line: green stroke (#22c55e matching app accent), strokeWidth 2
- CartesianGrid: subtle dashes (#27272a matching zinc-800)
- Tooltip: dark bg (#18181b), shows date and balance formatted with Intl.NumberFormat('de-DE')
- If no data or only 1 point: show empty state "Noch nicht genug Daten fuer ein Diagramm"
- Wrap in Card component with title "Guthaben-Verlauf (30 Tage)"

Create `src/components/wallet/claim-daily.tsx`:
- 'use client' component receiving dailyClaimInfo as prop
- Shows current claim info:
  - If can claim: green button "Taegliches Guthaben abholen" with amount preview
  - If already claimed: disabled button "Bereits abgeholt" with "Morgen wieder verfuegbar"
  - Below button: activity multiplier display "Dein Aktivitaetsbonus: {multiplier*100}%"
  - Next weekly bonus counter: "Naechster Wochenbonus in {n} Abholungen"
  - If this claim IS the weekly bonus: special highlight "Wochenbonus verfuegbar!" with star icon
- On claim: call claimDaily() server action, show toast with amount, update UI
- After successful claim: call fetchBalance() from socket provider to update sidebar widget
- Wrap in Card component with title "Taegliches Guthaben"
  </action>
  <verify>
`npx tsc --noEmit` passes. Navigate to /wallet as logged-in user. Page loads with balance header, chart (may show flat line), and daily claim button. Claim button works and updates balance in sidebar.
  </verify>
  <done>Wallet page exists at /wallet with balance chart and daily claim functionality. Chart shows 30-day balance history. Daily claim button with activity multiplier and weekly bonus counter.</done>
</task>

<task type="auto">
  <name>Task 2: Transaction list with filters and P2P transfer form</name>
  <files>src/components/wallet/transaction-list.tsx, src/components/wallet/transfer-form.tsx</files>
  <action>
Create `src/components/wallet/transaction-list.tsx`:
- 'use client' component receiving initial transactions as props
- Filter bar at top with tabs/buttons: "Alle" | "Gewinne" | "Verluste" | "Transfers" | "Admin"
  - Alle: no filter
  - Gewinne: GAME_WIN, DAILY_CLAIM, WEEKLY_BONUS, TRANSFER_RECEIVED, ADMIN_CREDIT
  - Verluste: BET_PLACED, BET_FORFEIT, TRANSFER_SENT, ADMIN_DEBIT
  - Transfers: TRANSFER_SENT, TRANSFER_RECEIVED
  - Admin: ADMIN_CREDIT, ADMIN_DEBIT
- Transactions grouped by day using date-fns:
  - Group header: "Heute", "Gestern", or formatted date "12. Februar 2026"
  - Each transaction row:
    - Icon: based on type (dice for game, arrow for transfer, gift for daily, shield for admin, etc.)
    - Description text (from transaction.description field, already in German)
    - Amount: green with + prefix for positive, red with - prefix for negative
    - Time: relative if today ("vor 2 Std."), otherwise HH:MM
- "Mehr laden" button at bottom for pagination (calls getTransactions with cursor)
- Empty state: "Keine Transaktionen gefunden" with filter-specific hint
- Wrap in Card with title "Transaktionen"
- Smooth scroll, max-height with overflow-y-auto

Create `src/components/wallet/transfer-form.tsx`:
- 'use client' component
- Form fields:
  1. Recipient: text input for username search
     - As user types (debounced 300ms), search users via a server action (add searchUsers to wallet.ts actions if not exists)
     - Show dropdown of matching users (displayName + username)
     - On select: set recipient userId and show selected user's displayName
  2. Amount: number input with min=1
     - Show current transfer limits below: "Max. {maxAmount} pro Transfer, {dailyLimit} pro Tag"
  3. Optional message: text input (stored in transaction metadata)
- Submit button: "Chips senden" with loading state
- On submit: call transferFunds server action
- On success: toast "Transfer erfolgreich!", reset form, call fetchBalance()
- On error: toast with error message
- If wallet is frozen: show warning and disable form
- Wrap in Card with title "Chips senden"
- Design: compact form, matching wallet page theme
  </action>
  <verify>
`npx tsc --noEmit` passes. Navigate to /wallet. Transaction list shows entries (may need to claim daily first to have data). Filter tabs filter correctly. Transfer form shows with user search (test by typing a username). Submit transfer updates both balances.
  </verify>
  <done>Transaction list with day grouping and filter tabs. Transfer form with user search, amount input, and limit display. Both integrated into wallet page. Transfers create matching transaction records for sender and receiver.</done>
</task>

</tasks>

<verification>
- /wallet page loads with all sections
- Balance chart renders line graph
- Daily claim works and updates sidebar balance
- Transaction list groups by day
- Filter tabs filter transaction types correctly
- Transfer form searches users, validates limits, completes transfer
- Sender and receiver balances update after transfer
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Full wallet page at /wallet with balance chart, daily claim with activity scaling, transaction history with filters, and P2P transfer form. All operations create transaction records and update balance in real-time.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-07-SUMMARY.md`
</output>
