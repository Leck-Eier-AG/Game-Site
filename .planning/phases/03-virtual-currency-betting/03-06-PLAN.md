---
phase: 03-virtual-currency-betting
plan: 06
type: execute
wave: 3
depends_on: ["03-01", "03-03"]
files_modified:
  - server.js
  - src/components/lobby/create-room-dialog.tsx
  - src/components/lobby/room-card.tsx
  - src/app/(app)/page.tsx
  - src/types/game.ts
autonomous: true

must_haves:
  truths:
    - "Room creator can toggle between free and bet room when creating"
    - "Bet room creation shows preset amounts plus custom input"
    - "Room creator can configure payout ratios with reasonable defaults"
    - "Lobby shows bet rooms with chip icon and bet amount badge"
    - "Lobby has filter tabs to show All, Free, or Bet rooms"
    - "Players with insufficient balance can see bet rooms and join as spectators"
  artifacts:
    - path: "src/components/lobby/create-room-dialog.tsx"
      provides: "Updated room creation with free/bet toggle, bet amount presets, payout ratio config"
      contains: "betAmount"
    - path: "src/components/lobby/room-card.tsx"
      provides: "Room card with chip icon and bet amount badge for bet rooms"
      contains: "Coins"
    - path: "server.js"
      provides: "Room creation handler accepting bet settings, room data includes bet info"
      contains: "betAmount"
    - path: "src/types/game.ts"
      provides: "Updated RoomSettings and RoomInfo types with betting fields"
      contains: "isBetRoom"
  key_links:
    - from: "src/components/lobby/create-room-dialog.tsx"
      to: "server.js"
      via: "room:create socket event with bet settings"
      pattern: "room:create.*betAmount"
    - from: "src/components/lobby/room-card.tsx"
      to: "src/types/game.ts"
      via: "RoomInfo.isBetRoom and betAmount for badge display"
      pattern: "isBetRoom"
---

<objective>
Room creation betting flow and lobby display with bet badges and filters.

Purpose: Per user decisions, room creators can choose between free and bet rooms with full control over bet amounts and payout ratios. The lobby must clearly distinguish bet rooms with chip icons and badge amounts, and provide filter tabs (All/Free/Bet).

Output: Updated room creation dialog with betting options, updated room cards with bet badges, lobby filter tabs, server-side room creation accepting bet settings.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-03-SUMMARY.md
@src/components/lobby/create-room-dialog.tsx
@src/components/lobby/room-card.tsx
@src/app/(app)/page.tsx
@src/types/game.ts
@server.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and server-side room creation for betting</name>
  <files>src/types/game.ts, server.js</files>
  <action>
Update `src/types/game.ts`:

Add to RoomSettings interface:
```typescript
isBetRoom: boolean          // true = bet room, false = free room (NOT just betAmount=0)
betAmount?: number          // buy-in per player (only if isBetRoom)
minBet?: number             // room min bet (optional override)
maxBet?: number             // room max bet (optional override)
payoutRatios?: { position: number; percentage: number }[]  // custom payout ratios
```

Add to RoomInfo interface:
```typescript
isBetRoom: boolean
betAmount: number           // 0 for free rooms
totalPot: number            // current pot (betAmount * activePlayers in bet rooms)
payoutRatios: { position: number; percentage: number }[]
```

Update `server.js`:

1. In RoomManager.createRoom():
   - Accept new settings fields: isBetRoom, betAmount, minBet, maxBet, payoutRatios
   - Store in room object: isBetRoom (default false), betAmount (default 0), payoutRatios (use default from SystemSettings if not provided)
   - For default payout ratios: read from SystemSettings. Since server.js has Prisma client, fetch SystemSettings.defaultPayoutRatios on room creation if payoutRatios not provided by creator.

2. In RoomManager.getPublicRooms():
   - Include isBetRoom, betAmount, totalPot (betAmount * players.length for bet rooms, 0 for free), payoutRatios in the returned room info objects

3. In room:create handler:
   - Validate bet settings: if isBetRoom, betAmount must be > 0
   - Pass all bet settings to createRoom

4. No escrow/buy-in logic yet (that's Plan 08). This plan just stores the bet configuration on rooms.
  </action>
  <verify>
`npx tsc --noEmit` passes. Create a room via the existing UI (without bet settings) - should still work with defaults (isBetRoom: false, betAmount: 0).
  </verify>
  <done>RoomSettings and RoomInfo types include betting fields. Server creates rooms with bet configuration. Room list includes bet info for lobby display. Existing free room flow still works.</done>
</task>

<task type="auto">
  <name>Task 2: Room creation dialog with betting options and lobby filter tabs</name>
  <files>src/components/lobby/create-room-dialog.tsx, src/components/lobby/room-card.tsx, src/app/(app)/page.tsx</files>
  <action>
Update `src/components/lobby/create-room-dialog.tsx`:

Add after the visibility toggle section:

1. **Free/Bet toggle** (styled like existing public/private badge toggle):
   - Two badges: "Kostenlos" (green) and "Einsatz" (yellow/amber) with chip icon
   - State: isBetRoom (default false)
   - Per user decision: separate toggle, not just betAmount=0

2. **Bet amount section** (shown only when isBetRoom is true):
   - Preset buttons: 50, 100, 250, 500 (styled as small badges, clickable, highlighted when selected)
   - Custom input field below with "Eigener Betrag" label
   - State: betAmount
   - Coin icon prefix on the input

3. **Payout ratios section** (shown only when isBetRoom is true, collapsible/advanced):
   - Default label: "Standard-Auszahlung: 60% / 30% / 10%"
   - Toggle to "Benutzerdefiniert"
   - When custom: 3 rows with position (1., 2., 3.) and percentage input
   - Validate percentages sum to 100 (show error if not)
   - State: payoutRatios array

4. Pass all bet settings to room:create socket event.

Update `src/components/lobby/room-card.tsx`:

- If room.isBetRoom:
  - Show chip icon (lucide Coins) + bet amount badge in the header area next to status badge
  - Badge text: "{betAmount} Chips" with amber/yellow styling
  - Show pot info: "Pot: {totalPot} Chips" in card content
- If not bet room:
  - Show "Kostenlos" badge with green styling (subtle)
- Update join button logic:
  - For bet rooms where player might have insufficient balance: button text "Zuschauen" instead of "Beitreten" (actual balance check happens in Plan 08 during join; for now just show the badge)

Update `src/app/(app)/page.tsx` (lobby page):

Add filter tabs above the room grid:
- Three tabs: "Alle" | "Kostenlos" | "Einsatz"
- State: activeFilter ('all' | 'free' | 'bet')
- Filter rooms array based on isBetRoom
- Tabs styled as pill-shaped buttons matching existing green accent theme
- Show count in each tab: "Alle (5)" | "Kostenlos (3)" | "Einsatz (2)"
  </action>
  <verify>
`npx tsc --noEmit` passes. Start dev server, open lobby, create a bet room with preset amount. Verify room card shows chip badge. Filter tabs switch between views. Create a free room, verify it shows "Kostenlos" badge. Both room types visible under "Alle" tab.
  </verify>
  <done>Room creation dialog has free/bet toggle with preset amounts and custom input. Payout ratios configurable. Room cards show chip icon and bet amount badge for bet rooms. Lobby has filter tabs (All/Free/Bet).</done>
</task>

</tasks>

<verification>
- Create free room: works as before, shows "Kostenlos" in lobby
- Create bet room with preset 100: shows chip icon + "100 Chips" badge
- Create bet room with custom 350: shows "350 Chips" badge
- Custom payout ratios validate sum=100
- Filter tabs filter correctly
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Room creator can toggle free/bet, select preset or custom bet amount, configure payout ratios. Lobby clearly distinguishes bet rooms with visual badges. Filter tabs work. All settings stored on room and visible in lobby.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-06-SUMMARY.md`
</output>
