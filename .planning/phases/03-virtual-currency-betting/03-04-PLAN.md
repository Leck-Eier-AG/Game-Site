---
phase: 03-virtual-currency-betting
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/wallet/activity-score.ts
  - src/lib/wallet/daily-allowance.ts
  - src/lib/actions/wallet.ts
autonomous: true

must_haves:
  truths:
    - "Any player can claim daily allowance once per day via manual button"
    - "Daily amount scales with player activity (games played, time active, login streak)"
    - "Weekly bonus replaces daily amount every 7th claim"
    - "Player can transfer chips to another player with admin-configurable limits"
    - "Frozen wallets cannot send transfers but can receive them"
    - "All operations create transaction records and are ACID-safe"
  artifacts:
    - path: "src/lib/wallet/activity-score.ts"
      provides: "Activity multiplier calculation based on recent gameplay metrics"
      exports: ["calculateActivityMultiplier", "getUserActivityMetrics"]
    - path: "src/lib/wallet/daily-allowance.ts"
      provides: "Daily claim and weekly bonus logic with streak tracking"
      exports: ["claimDailyAllowance", "canClaimDaily", "getDailyClaimInfo"]
    - path: "src/lib/actions/wallet.ts"
      provides: "Server actions for transfer, daily claim, and balance queries"
      exports: ["transferFunds", "claimDaily", "getWalletData"]
  key_links:
    - from: "src/lib/wallet/daily-allowance.ts"
      to: "src/lib/wallet/activity-score.ts"
      via: "calculateActivityMultiplier called during claim"
      pattern: "calculateActivityMultiplier"
    - from: "src/lib/actions/wallet.ts"
      to: "src/lib/wallet/transactions.ts"
      via: "creditBalance/debitBalance for transfers"
      pattern: "(creditBalance|debitBalance)"
    - from: "src/lib/actions/wallet.ts"
      to: "src/lib/wallet/daily-allowance.ts"
      via: "claimDailyAllowance for daily claim action"
      pattern: "claimDailyAllowance"
---

<objective>
Daily allowance with activity scaling, weekly bonus, and player-to-player transfers.

Purpose: Per user decisions, daily allowance scales with activity and weekly bonus rewards consistency. P2P transfers create a social economy ("like PayPal"). These are the core earning and exchange mechanisms.

Output: Server actions for claiming daily allowance and transferring chips, activity scoring algorithm, weekly bonus on 7th claim.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@src/lib/wallet/transactions.ts
@src/lib/wallet/types.ts
@src/lib/actions/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity scoring and daily allowance with weekly bonus</name>
  <files>src/lib/wallet/activity-score.ts, src/lib/wallet/daily-allowance.ts</files>
  <action>
Create `src/lib/wallet/activity-score.ts`:

Define ActivityMetrics interface: { gamesLast7Days: number, activeMinutesLast7Days: number, loginStreakDays: number }

`getUserActivityMetrics(userId: string): Promise<ActivityMetrics>`:
- Query Transaction table for GAME_WIN and BET_PLACED entries in last 7 days to count games
- For activeMinutesLast7Days: estimate from transaction frequency (count distinct days with transactions * 30 as rough proxy, since we don't track active minutes directly yet)
- For loginStreakDays: use the wallet's dailyClaimStreak field
- Return metrics object

`calculateActivityMultiplier(metrics: ActivityMetrics): number`:
- Base: 1.0
- Games: +0.05 per game, cap +0.5 (10 games)
- Active time: +0.01 per 30min estimate, cap +0.3
- Login streak: +0.02 per day, cap +0.2
- Total cap: 2.0
- Return multiplier as number

Create `src/lib/wallet/daily-allowance.ts`:

`canClaimDaily(userId: string): Promise<boolean>`:
- Fetch wallet.lastDailyClaim
- Return true if lastDailyClaim is null or was before today (midnight comparison in user's context, use UTC for simplicity)

`getDailyClaimInfo(userId: string): Promise<{ canClaim: boolean, amount: number, multiplier: number, nextBonusIn: number, isWeeklyBonus: boolean }>`:
- Check canClaimDaily
- Fetch SystemSettings for dailyAllowanceBase and weeklyBonusAmount
- Get activity multiplier
- Determine if this claim is a weekly bonus: (wallet.dailyClaimStreak + 1) % 7 === 0
- If weekly bonus: amount = weeklyBonusAmount (no multiplier applied to bonus, it's a fixed amount)
- If daily: amount = Math.floor(dailyAllowanceBase * multiplier)
- nextBonusIn = 7 - ((wallet.dailyClaimStreak + 1) % 7) claims until next bonus
- Return info object

`claimDailyAllowance(userId: string): Promise<{ amount: number, type: 'DAILY_CLAIM' | 'WEEKLY_BONUS', multiplier: number }>`:
- Non-accumulating: only claim current day (per research recommendation)
- Inside Prisma transaction (Serializable):
  1. Verify canClaim (check lastDailyClaim again inside transaction to prevent double-claim race)
  2. Calculate amount using getDailyClaimInfo logic (re-derive inside transaction)
  3. Determine if weekly bonus
  4. Update wallet: increment balance, set lastDailyClaim to now(), increment dailyClaimStreak (reset to 0 if gap > 1 day for streak break)
  5. Create Transaction record with type DAILY_CLAIM or WEEKLY_BONUS, description in German:
     - Daily: "Taegliches Guthaben ({multiplier*100}% Aktivitaet)"
     - Weekly: "Woechentlicher Bonus (Claim #{streak})"
  6. Store metadata: { baseAmount, multiplier, metrics, isWeeklyBonus }
- Return result
  </action>
  <verify>
`npx tsc --noEmit` passes. Functions are importable without errors.
  </verify>
  <done>Activity scoring calculates multiplier from gameplay metrics. Daily allowance is claimable once per day with activity scaling. Weekly bonus triggers every 7th consecutive claim. Non-accumulating design prevents hoarding.</done>
</task>

<task type="auto">
  <name>Task 2: Server actions for transfers and wallet data</name>
  <files>src/lib/actions/wallet.ts</files>
  <action>
Create `src/lib/actions/wallet.ts` as 'use server' module:

1. `getWalletData(userId?: string)`:
   - If no userId, get from session (requireAuth)
   - Fetch wallet with getWalletWithUser
   - Fetch daily claim info with getDailyClaimInfo
   - Fetch SystemSettings for currency name
   - Return { wallet, dailyClaimInfo, currencyName }

2. `claimDaily()`:
   - Authenticate via getSession
   - Call claimDailyAllowance(session.userId)
   - Return { success: true, amount, type, multiplier }
   - On error: return { error: string }

3. `transferFunds(prevState, formData)`:
   - Authenticate via getSession
   - Parse with transferSchema (toUserId, amount)
   - Validate: sender !== receiver
   - Fetch SystemSettings for transfer limits (transferMaxAmount, transferDailyLimit)
   - Check single transfer <= transferMaxAmount
   - Check daily total: sum today's TRANSFER_SENT transactions for sender, verify + amount <= transferDailyLimit
   - Check sender wallet not frozen
   - Inside Prisma transaction (Serializable):
     a. Debit sender (type: TRANSFER_SENT, description: "Transfer an {recipientDisplayName}")
     b. Credit receiver (type: TRANSFER_RECEIVED, description: "Transfer von {senderDisplayName}")
   - Emit balance:updated to both users via Socket.IO (need to export io instance or use a shared reference - use the existing pattern from server.js; alternatively, since server actions run in Next.js, not the custom server, we need a different approach: after transaction completes, the client can refetch balance, OR we can make transfers go through a socket event instead)

   IMPORTANT NOTE: Server actions run in Next.js process, not in the custom server.js. For real-time balance updates after server action mutations, the client component should call fetchBalance() from the socket provider after the action succeeds. The Socket.IO balance:updated event is primarily for when OTHER processes change your balance (e.g., game end payout, admin adjustment). Document this pattern clearly.

4. `getTransactions(options?: { type?: string, limit?: number, cursor?: string })`:
   - Authenticate via getSession
   - Call getTransactionHistory from wallet/transactions.ts
   - Return transactions array

5. `getBalanceChartData(days?: number)`:
   - Authenticate via getSession
   - Call getBalanceHistory from wallet/transactions.ts
   - Return array of { date, balance } points for chart
  </action>
  <verify>
`npx tsc --noEmit` passes. Server actions are importable. Test claimDaily by calling from a temp page or script.
  </verify>
  <done>Server actions exist for claiming daily allowance, transferring funds, fetching wallet data and transaction history. Transfer limits are enforced from SystemSettings. Frozen wallet check prevents outbound operations.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Daily claim can only be called once per day
- Transfer validates limits and frozen status
- All operations create Transaction records
- Weekly bonus triggers on 7th consecutive claim
</verification>

<success_criteria>
Daily allowance claimable once per day with activity-scaled amounts. Weekly bonus every 7 claims. P2P transfers enforce configurable limits. Frozen wallets blocked from outbound operations. All changes logged as immutable transactions.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-04-SUMMARY.md`
</output>
