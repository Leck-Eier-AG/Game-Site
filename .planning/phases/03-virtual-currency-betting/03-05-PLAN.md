---
phase: 03-virtual-currency-betting
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(app)/admin/finance/page.tsx
  - src/app/(app)/admin/finance/layout.tsx
  - src/components/admin/finance-dashboard.tsx
  - src/components/admin/transaction-log.tsx
  - src/components/admin/economic-settings.tsx
  - src/lib/actions/admin-finance.ts
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view economy dashboard with total circulation, transaction volume, top earners"
    - "Admin can view full transaction log filterable by type"
    - "Admin can edit all economic parameters (currency name, starting balance, daily allowance, etc.)"
    - "Admin finance page is separate from existing admin dashboard"
    - "Changes to system settings take effect immediately without code deployment"
  artifacts:
    - path: "src/app/(app)/admin/finance/page.tsx"
      provides: "Admin finance page with dashboard, transaction log, and settings tabs"
      contains: "FinanceDashboard"
    - path: "src/components/admin/finance-dashboard.tsx"
      provides: "Economy charts showing circulation, volume, top earners, average balance"
      exports: ["FinanceDashboard"]
    - path: "src/components/admin/transaction-log.tsx"
      provides: "Full filterable transaction log with pagination"
      exports: ["TransactionLog"]
    - path: "src/components/admin/economic-settings.tsx"
      provides: "Form for all SystemSettings fields with save"
      exports: ["EconomicSettings"]
    - path: "src/lib/actions/admin-finance.ts"
      provides: "Server actions for admin finance operations"
      exports: ["getEconomyStats", "getAdminTransactionLog", "updateSystemSettings"]
  key_links:
    - from: "src/components/admin/finance-dashboard.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "getEconomyStats for dashboard data"
      pattern: "getEconomyStats"
    - from: "src/components/admin/economic-settings.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "updateSystemSettings server action"
      pattern: "updateSystemSettings"
---

<objective>
Admin finance page with economy dashboard, transaction log, and system settings.

Purpose: Per user decisions, admin needs a dedicated finance page (separate from existing admin dashboard) with full economic control. Charts show economy health, transaction log provides audit trail, and settings page enables live tuning without deployment.

Output: Admin finance page at /admin/finance with three sections: economy dashboard with charts, full transaction log, and economic settings form.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@src/app/(app)/admin/page.tsx
@src/app/(app)/admin/layout.tsx
@src/lib/actions/admin.ts
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin finance server actions and data layer</name>
  <files>src/lib/actions/admin-finance.ts</files>
  <action>
Install recharts and date-fns: `npm install recharts date-fns`

Create `src/lib/actions/admin-finance.ts` as 'use server' module:

1. `getEconomyStats()`:
   - requireAdmin()
   - Query aggregates in parallel:
     a. Total circulation: sum of all wallet balances
     b. Average balance: avg of all wallet balances
     c. Total users with wallets: count
     d. Daily transaction volume (last 30 days): group by day, count and sum amounts
     e. Top 5 earners: wallets ordered by balance desc, limit 5, include user displayName
     f. Top 5 spenders: wallets ordered by balance asc (or total TRANSFER_SENT+BET_PLACED amount), limit 5
     g. Transaction type distribution: group by type, count
   - Return structured stats object

2. `getAdminTransactionLog(options: { type?: string, userId?: string, limit?: number, cursor?: string })`:
   - requireAdmin()
   - Query Transaction with filters, include user and relatedUser displayNames
   - Cursor-based pagination (createdAt + id)
   - Return { transactions, nextCursor }

3. `getSystemSettings()`:
   - requireAdmin()
   - Return SystemSettings row

4. `updateSystemSettings(prevState, formData)`:
   - requireAdmin()
   - Parse all SystemSettings fields from formData
   - Validate with systemSettingsSchema from validations/wallet.ts
   - Update the single SystemSettings row
   - revalidatePath('/admin/finance')
   - Return { success: true }

5. `adjustUserBalance(prevState, formData)`:
   - requireAdmin()
   - Parse: userId, amount (positive=credit, negative=debit), reason (optional)
   - Inside Prisma transaction: credit or debit balance, create Transaction (ADMIN_CREDIT or ADMIN_DEBIT), include reason in description
   - Return { success: true, newBalance }

6. `bulkAdjustBalance(prevState, formData)`:
   - requireAdmin()
   - Parse: userIds (JSON array or "all"), amount, reason
   - If "all": fetch all user IDs
   - Loop through users, apply adjustUserBalance logic for each (inside one large transaction)
   - Return { success: true, affected: count }

7. `freezeWallet(userId: string)`:
   - requireAdmin()
   - Set wallet.frozenAt = new Date()
   - Return { success: true }

8. `unfreezeWallet(userId: string)`:
   - requireAdmin()
   - Set wallet.frozenAt = null
   - Return { success: true }
  </action>
  <verify>
`npx tsc --noEmit` passes. All server actions are importable.
  </verify>
  <done>Admin finance server actions exist for economy stats, transaction log, settings management, balance adjustments (single/bulk), and wallet freeze/unfreeze.</done>
</task>

<task type="auto">
  <name>Task 2: Admin finance page with dashboard, transaction log, and settings</name>
  <files>src/app/(app)/admin/finance/page.tsx, src/app/(app)/admin/finance/layout.tsx, src/components/admin/finance-dashboard.tsx, src/components/admin/transaction-log.tsx, src/components/admin/economic-settings.tsx, src/components/layout/sidebar.tsx</files>
  <action>
Create `src/app/(app)/admin/finance/layout.tsx`:
- Import requireAdmin from auth/dal
- Simple layout that checks admin access (same pattern as existing admin layout)

Create `src/app/(app)/admin/finance/page.tsx`:
- Server component that fetches initial data: getEconomyStats(), getSystemSettings(), getAdminTransactionLog({ limit: 50 })
- Renders page with German title "Finanzverwaltung"
- Three tab sections using a simple tab UI (can use Radix Tabs or just button toggles with state):
  - "Dashboard" tab: FinanceDashboard component
  - "Transaktionen" tab: TransactionLog component
  - "Einstellungen" tab: EconomicSettings component

Create `src/components/admin/finance-dashboard.tsx`:
- 'use client' component receiving stats as props
- Top row: 4 stat cards (total circulation, average balance, active wallets, daily volume) using existing Card component
- Charts using Recharts (must install recharts):
  - Line chart: daily transaction volume over last 30 days (ResponsiveContainer + LineChart)
  - Bar chart: transaction type distribution
- Tables:
  - Top 5 earners (displayName, balance)
  - Top 5 spenders (displayName, total spent)
- All in dark theme matching existing admin: bg-zinc-900, text-white, green accent
- Use Intl.NumberFormat('de-DE') for number formatting

Create `src/components/admin/transaction-log.tsx`:
- 'use client' component with server action integration
- Filter controls: dropdown for TransactionType, text input for userId search
- Table (use existing shadcn Table component) with columns: Datum, Typ, Nutzer, Betrag, Beschreibung
- Each row shows transaction with color-coded amount (green positive, red negative)
- "Mehr laden" button for cursor-based pagination
- Loading states for filter changes

Create `src/components/admin/economic-settings.tsx`:
- 'use client' component receiving current settings as props
- Form with all SystemSettings fields:
  - Waehrungsname (text input)
  - Startguthaben (number input)
  - Taegliches Guthaben (number input)
  - Woechentlicher Bonus (number input)
  - Transfer-Maximum (number input)
  - Taegliches Transfer-Limit (number input)
  - Standard-Einsaetze (comma-separated number input, parsed to JSON array)
  - Standard-Auszahlungsquoten (editable table: position + percentage)
  - AFK-Gnadenfrist (number input, seconds)
  - Alarm: Transfer-Grenze (number input)
  - Alarm: Guthaben-Verlust % (number input)
- "Speichern" button calls updateSystemSettings server action
- Success/error toast feedback
- All labels in German

Update `src/components/layout/sidebar.tsx`:
- Add nav item for admin finance page:
  ```
  { href: '/admin/finance', label: 'Finanzen', icon: Coins, roles: ['ADMIN'] }
  ```
  Import Coins from lucide-react. Place it after the Administration nav item.
  </action>
  <verify>
`npx tsc --noEmit` passes. Start dev server, navigate to /admin/finance as admin. Dashboard shows stats (may be zeros initially). Settings form loads with current values. Transaction log renders (may be empty).
  </verify>
  <done>Admin finance page exists at /admin/finance with economy dashboard charts, filterable transaction log, and editable system settings. Admin nav includes "Finanzen" link. All economic parameters configurable without code changes.</done>
</task>

</tasks>

<verification>
- /admin/finance page loads for admin users
- Dashboard shows economy metrics (even if zeros initially)
- Transaction log filters by type
- System settings save and persist across page reload
- Sidebar shows "Finanzen" link for admin users only
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Admin finance page is live at /admin/finance with three sections. Economy dashboard shows total circulation, volume, and leaderboards. Transaction log is filterable and paginated. System settings form saves all economic parameters. Changes take effect immediately.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-05-SUMMARY.md`
</output>
