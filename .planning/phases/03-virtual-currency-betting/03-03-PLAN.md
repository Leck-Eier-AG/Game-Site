---
phase: 03-virtual-currency-betting
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - server.js
  - src/lib/socket/provider.tsx
  - src/components/wallet/balance-widget.tsx
  - src/components/wallet/balance-popover.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User sees their current balance on every page in the sidebar"
    - "Balance updates animate with green/red flash on change"
    - "Hovering sidebar balance shows popover with last 3 transactions"
    - "Clicking sidebar balance navigates to wallet page"
    - "Balance updates arrive in real-time via Socket.IO without page refresh"
  artifacts:
    - path: "src/components/wallet/balance-widget.tsx"
      provides: "Persistent sidebar balance display with animated counter and click-to-navigate"
      exports: ["BalanceWidget"]
    - path: "src/components/wallet/balance-popover.tsx"
      provides: "Hover popover showing last 3 transactions with descriptions"
      exports: ["BalancePopover"]
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated sidebar with BalanceWidget between nav and connection status"
      contains: "BalanceWidget"
    - path: "server.js"
      provides: "Socket.IO user-specific room join and balance:updated event emission"
      contains: "balance:updated"
  key_links:
    - from: "server.js"
      to: "src/components/wallet/balance-widget.tsx"
      via: "Socket.IO balance:updated event with newBalance, change, description"
      pattern: "balance:updated"
    - from: "src/components/wallet/balance-widget.tsx"
      to: "src/lib/socket/provider.tsx"
      via: "useSocket hook for balance event listener"
      pattern: "useSocket"
---

<objective>
Real-time balance display in sidebar with Socket.IO events for live updates.

Purpose: Per user decision, balance must be visible on every page as a persistent widget. This plan establishes the real-time balance infrastructure (Socket.IO events) and the sidebar widget that all other wallet features depend on for visual feedback.

Output: Balance widget in sidebar, hover popover with recent transactions, Socket.IO events for balance changes, animated counter with green/red flash.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@src/components/layout/sidebar.tsx
@src/components/layout/mobile-sidebar.tsx
@src/lib/socket/provider.tsx
@server.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Socket.IO user-specific rooms and balance events</name>
  <files>server.js, src/lib/socket/provider.tsx</files>
  <action>
Install react-countup: `npm install react-countup`

Update `server.js`:

1. In the `io.on('connection')` handler, after auth middleware sets socket.data.userId, add:
   ```
   socket.join(`user:${socket.data.userId}`)
   ```
   This creates a user-specific room for targeted balance events.

2. Add a new socket event handler `wallet:get-balance` that:
   - Imports getWalletWithUser from wallet/transactions.ts (add import at top using dynamic import or direct import pattern matching existing imports)
   - Fetches wallet for socket.data.userId using getWalletWithUser
   - Returns { balance, currencyName } via callback
   - If wallet doesn't exist yet, getWalletWithUser will lazily create it

3. Add a new socket event handler `wallet:recent-transactions` that:
   - Imports getTransactionHistory from wallet/transactions.ts
   - Fetches last 3 transactions for socket.data.userId
   - Returns array of { type, amount, description, createdAt } via callback

4. Create a helper function `emitBalanceUpdate(io, userId, newBalance, change, description)` that:
   ```javascript
   io.to(`user:${userId}`).emit('balance:updated', { newBalance, change, description })
   ```
   Export this pattern for use after any balance-modifying operation. This function should be called AFTER transaction commits, not inside them (per research pitfall 4).

Note: The existing server.js uses ESM imports at the top (import ... from ...). Add wallet imports similarly. Since wallet/transactions.ts uses Prisma, import it the same way the existing prisma import works. The server.js file already imports from './src/lib/game/...' pattern.

Update `src/lib/socket/provider.tsx`:
- Add a `balance` state (number | null) and `balanceChange` state ({ amount: number, timestamp: number } | null) to the context
- Listen for 'balance:updated' event, update balance state and set balanceChange for animation trigger
- Add `fetchBalance()` function that emits 'wallet:get-balance' and updates state
- Call fetchBalance on initial connection
- Expose balance, balanceChange, and fetchBalance in context value
  </action>
  <verify>
`npx tsc --noEmit` passes. Server starts without import errors. Connect a socket client and verify 'wallet:get-balance' returns a balance.
  </verify>
  <done>Socket.IO joins user-specific rooms on connect. Balance fetch and update events work. Provider exposes reactive balance state.</done>
</task>

<task type="auto">
  <name>Task 2: Sidebar balance widget with animated counter and hover popover</name>
  <files>src/components/wallet/balance-widget.tsx, src/components/wallet/balance-popover.tsx, src/components/layout/sidebar.tsx, src/components/layout/mobile-sidebar.tsx</files>
  <action>
Create `src/components/wallet/balance-widget.tsx`:
- 'use client' component
- Uses useSocket() to get balance, balanceChange from provider
- Displays balance using react-countup CountUp component:
  - start from previous balance, end at current balance
  - duration 0.8s, separator "." (German locale thousands), preserveValue
  - Wrap in a div that flashes green (positive change) or red (negative change) via CSS animation class that auto-removes after 1s
- Shows currency name next to amount (fetch from SystemSettings via a socket event or hardcode "Chips" initially and read from provider later)
- Coin/chip icon (use lucide `Coins` icon) next to the amount
- Entire widget is wrapped in Next.js Link to "/wallet"
- On hover, shows BalancePopover (use Radix Popover or simple CSS hover with absolute positioning)
- Loading skeleton when balance is null (initial load)
- Tailwind classes matching existing sidebar style: text-white, bg-zinc-800/50 rounded-lg, padding

Create `src/components/wallet/balance-popover.tsx`:
- 'use client' component
- Fetches last 3 transactions via socket 'wallet:recent-transactions' event on mount
- Displays each transaction as a small row:
  - Icon based on type (green arrow up for credit, red arrow down for debit)
  - Description text (truncated to ~30 chars)
  - Amount with +/- prefix and color
  - Relative time ("vor 2 Stunden") using simple relative time formatting
- "Alle Transaktionen" link at bottom pointing to /wallet
- Dark theme matching sidebar: bg-zinc-800, border-zinc-700, text-sm

Update `src/components/layout/sidebar.tsx`:
- Import BalanceWidget
- Add BalanceWidget between the navigation section and ConnectionStatus section
- Wrap in a div with border-t border-white/10 and padding matching existing sections

Update `src/components/layout/mobile-sidebar.tsx`:
- Import BalanceWidget
- Add BalanceWidget in equivalent position in mobile sidebar
- Ensure it works with the Sheet component's layout
  </action>
  <verify>
`npx tsc --noEmit` passes. Start dev server, log in, verify balance appears in sidebar. Hover shows popover (may be empty if no transactions yet). New user should see starting balance from SystemSettings.
  </verify>
  <done>Balance visible in sidebar on every page. Animated counter ticks on changes. Hover popover shows recent transactions. Click navigates to /wallet. Works on both desktop and mobile sidebar.</done>
</task>

</tasks>

<verification>
- Balance widget visible in sidebar for all authenticated users
- Counter animates on balance change (test by manually calling creditBalance in a script)
- Hover popover appears with transaction preview
- Click navigates to /wallet (404 is OK at this stage, page comes in Plan 07)
- Mobile sidebar also shows balance
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Every authenticated user sees their balance in the sidebar. Balance updates arrive in real-time via Socket.IO. Hover popover shows last 3 transactions. Counter animation with green/red flash works on changes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-03-SUMMARY.md`
</output>
