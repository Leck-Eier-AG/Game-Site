---
phase: 03-virtual-currency-betting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/seed.ts
  - src/lib/wallet/transactions.ts
  - src/lib/wallet/types.ts
  - src/lib/validations/wallet.ts
autonomous: true

must_haves:
  truths:
    - "Wallet, Transaction, BetEscrow, SystemSettings models exist in database"
    - "New user registration creates wallet with admin-configured starting balance"
    - "All balance changes create immutable transaction records with descriptive metadata"
    - "Concurrent balance operations cannot produce negative balances or race conditions"
    - "SystemSettings table has exactly one row with all configurable economic parameters"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Wallet, Transaction, BetEscrow, SystemSettings models with enums and indexes"
      contains: "model Wallet"
    - path: "src/lib/wallet/transactions.ts"
      provides: "ACID-safe balance operations (credit, debit, transfer) using Prisma interactive transactions"
      exports: ["creditBalance", "debitBalance", "getWalletWithUser", "getSystemSettings"]
    - path: "src/lib/wallet/types.ts"
      provides: "TypeScript types for wallet operations, transaction types, escrow states"
      exports: ["TransactionType", "EscrowStatus"]
    - path: "src/lib/validations/wallet.ts"
      provides: "Zod schemas for all wallet-related inputs"
      exports: ["transferSchema", "betSchema", "adjustBalanceSchema"]
    - path: "prisma/seed.ts"
      provides: "Database seed script that creates SystemSettings defaults"
      contains: "systemSettings"
  key_links:
    - from: "src/lib/wallet/transactions.ts"
      to: "prisma/schema.prisma"
      via: "Prisma client with Serializable isolation"
      pattern: "prisma\\.\\$transaction"
    - from: "src/lib/wallet/transactions.ts"
      to: "prisma/schema.prisma"
      via: "Transaction record creation inside every balance operation"
      pattern: "tx\\.transaction\\.create"
---

<objective>
Database schema for virtual currency system and ACID-safe core wallet operations.

Purpose: Establish the financial data foundation that every other plan in this phase depends on. Wallet, Transaction, BetEscrow, and SystemSettings models with proper indexes, constraints, and enums. Core library functions for safe balance operations using Prisma interactive transactions with Serializable isolation.

Output: Updated Prisma schema with 4 new models, migration applied, seed script for SystemSettings defaults, core wallet transaction library, Zod validation schemas, TypeScript types.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@prisma/schema.prisma
@src/lib/actions/auth.ts
@src/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema with Wallet, Transaction, BetEscrow, SystemSettings models</name>
  <files>prisma/schema.prisma, prisma/seed.ts</files>
  <action>
Update prisma/schema.prisma adding these models (keep all existing models intact):

1. **Wallet model:**
   - id (cuid), userId (unique, references User), balance (Int, default 0), frozenAt (DateTime?), lastDailyClaim (DateTime?), dailyClaimStreak (Int, default 0), registeredAt (DateTime, default now()), createdAt, updatedAt
   - Relation: user User (onDelete: Cascade)
   - Index on balance (for leaderboards)

2. **Transaction model:**
   - id (cuid), type (TransactionType enum), amount (Int), userId (references User), relatedUserId (String?), roomId (String?), description (String), metadata (Json?), createdAt (DateTime, default now())
   - Relations: user User, relatedUser User? ("RelatedTransactions")
   - Indexes: (userId, createdAt desc), (type, createdAt desc), (roomId)

3. **BetEscrow model:**
   - id (cuid), roomId (String), userId (references User), amount (Int), status (EscrowStatus enum), lockedAt (DateTime?), releasedAt (DateTime?), createdAt (DateTime, default now())
   - Relations: user User
   - Unique constraint: (roomId, userId)
   - Index: (status, createdAt)

4. **SystemSettings model:**
   - id (cuid), currencyName (String, default "Chips"), startingBalance (Int, default 1000), dailyAllowanceBase (Int, default 100), weeklyBonusAmount (Int, default 500), transferMaxAmount (Int, default 1000), transferDailyLimit (Int, default 5000), defaultBetPresets (Json, default "[50,100,250,500]"), defaultPayoutRatios (Json, default "[{\"position\":1,\"percentage\":60},{\"position\":2,\"percentage\":30},{\"position\":3,\"percentage\":10}]"), afkGracePeriodSec (Int, default 30), alertTransferLimit (Int, default 2000), alertBalanceDropPct (Int, default 50), updatedAt (DateTime, @updatedAt)

5. **Enums:**
   - TransactionType: INITIAL, DAILY_CLAIM, WEEKLY_BONUS, GAME_WIN, BET_PLACED, BET_REFUND, BET_FORFEIT, TRANSFER_SENT, TRANSFER_RECEIVED, ADMIN_CREDIT, ADMIN_DEBIT
   - EscrowStatus: PENDING, LOCKED, RELEASED, FORFEITED

6. **Update User model:** Add relations for Wallet (one-to-one), transactions (one-to-many), relatedTransactions (one-to-many "RelatedTransactions"), betEscrows (one-to-many)

Add a `prisma/seed.ts` script that:
- Creates a single SystemSettings row with defaults (upsert to be idempotent)
- Add `"prisma": { "seed": "tsx prisma/seed.ts" }` to package.json

Run `npx prisma db push` to apply schema changes. Do NOT use `prisma migrate dev` (in-memory room storage means we don't track migrations formally yet).

Run `npx prisma db seed` to create SystemSettings.
  </action>
  <verify>
Run `npx prisma db push` succeeds without errors. Run `npx prisma db seed` succeeds. Run `npx prisma studio` or query SystemSettings to confirm row exists.
  </verify>
  <done>All 4 models exist in database. SystemSettings has one row with configurable defaults. User model has new relations. No existing functionality broken.</done>
</task>

<task type="auto">
  <name>Task 2: Core wallet operations library with ACID transactions</name>
  <files>src/lib/wallet/transactions.ts, src/lib/wallet/types.ts, src/lib/validations/wallet.ts</files>
  <action>
Create `src/lib/wallet/types.ts`:
- Re-export TransactionType and EscrowStatus from Prisma (or define matching TS types)
- Define WalletWithUser type (Wallet + user displayName/username)
- Define TransactionWithDetails type (Transaction + related user info)
- Define SystemSettingsConfig type matching the SystemSettings model
- Define CreditResult, DebitResult types for operation returns

Create `src/lib/wallet/transactions.ts`:
- Import prisma from '@/lib/db'
- Import { Prisma } from '@prisma/client' for TransactionIsolationLevel

Core functions (ALL use Prisma interactive transactions with Serializable isolation):

1. `getSystemSettings()` - Fetch the single SystemSettings row (cache-friendly, called often). Use `findFirst()` since there's only one row.

2. `getWalletWithUser(userId)` - Fetch wallet with user info. If wallet doesn't exist, create one with starting balance from SystemSettings (lazy initialization for existing users). Create INITIAL transaction record.

3. `creditBalance(userId, amount, type, description, metadata?)` - Add to balance inside transaction, create Transaction record. Return updated wallet. Validates amount > 0.

4. `debitBalance(userId, amount, type, description, metadata?)` - Subtract from balance inside transaction. Check balance >= amount INSIDE transaction before decrement. Create Transaction record. Throws if insufficient balance. Check wallet not frozen (frozenAt !== null) for outbound operations.

5. `getTransactionHistory(userId, options?: { type?, limit?, cursor? })` - Paginated transaction list with cursor-based pagination. Include relatedUser info for transfers. Order by createdAt desc.

6. `getBalanceHistory(userId, days?)` - Get daily balance snapshots for chart. Calculate running balance from transactions grouped by day.

All functions must:
- Use `isolationLevel: Prisma.TransactionIsolationLevel.Serializable`
- Set `maxWait: 5000, timeout: 10000`
- Create Transaction records INSIDE the same transaction as balance changes
- Validate frozen status for debit operations (frozen wallets can receive but not send)
- Use integer arithmetic only (no floating point)

Create `src/lib/validations/wallet.ts`:
- transferSchema: { toUserId: string, amount: number (positive int, min 1) }
- adjustBalanceSchema: { userId: string, amount: number (can be negative), reason: string? }
- betSettingsSchema: { betAmount: number (positive int), minBet?: number, maxBet?: number, payoutRatios: array of {position, percentage} }
- systemSettingsSchema: all configurable fields from SystemSettings model

Use Zod v4 syntax (already in project: zod@4.3.6).
  </action>
  <verify>
`npx tsc --noEmit` passes. Import the functions in a test script or verify no TypeScript errors. Check that Prisma client generates correctly with `npx prisma generate`.
  </verify>
  <done>Core wallet library exists with ACID-safe creditBalance, debitBalance, getWalletWithUser, getSystemSettings, getTransactionHistory, getBalanceHistory. All operations use Serializable isolation. Zod schemas validate all wallet inputs. Types are exported for use by other plans.</done>
</task>

</tasks>

<verification>
- `npx prisma db push` applies without errors
- `npx prisma generate` produces updated client
- `npx tsc --noEmit` passes with no type errors
- SystemSettings row exists in database with defaults
- All wallet functions are importable and type-safe
</verification>

<success_criteria>
Database has Wallet, Transaction, BetEscrow, SystemSettings tables. Core wallet library provides ACID-safe balance operations. Every balance change creates an immutable transaction record. SystemSettings stores all configurable economic parameters.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md`
</output>
