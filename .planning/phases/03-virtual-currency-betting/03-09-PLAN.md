---
phase: 03-virtual-currency-betting
plan: 09
type: execute
wave: 4
depends_on: ["03-05", "03-08"]
files_modified:
  - src/components/admin/balance-adjust.tsx
  - src/components/admin/alert-monitor.tsx
  - src/app/(app)/admin/finance/page.tsx
  - src/lib/actions/admin-finance.ts
autonomous: true

must_haves:
  truths:
    - "Admin can adjust a single user's balance with optional reason"
    - "Admin can bulk adjust multiple users or all users at once"
    - "Admin can freeze a user's wallet (blocks outbound but allows inbound)"
    - "Suspicious activity alerts show in admin finance dashboard"
    - "All admin balance changes are logged in transaction history"
  artifacts:
    - path: "src/components/admin/balance-adjust.tsx"
      provides: "Single and bulk balance adjustment UI with user selection and reason field"
      exports: ["BalanceAdjust"]
    - path: "src/components/admin/alert-monitor.tsx"
      provides: "Suspicious activity alert display with configurable thresholds"
      exports: ["AlertMonitor"]
    - path: "src/app/(app)/admin/finance/page.tsx"
      provides: "Updated finance page with balance tools and alerts sections"
      contains: "BalanceAdjust"
  key_links:
    - from: "src/components/admin/balance-adjust.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "adjustUserBalance and bulkAdjustBalance server actions"
      pattern: "(adjustUserBalance|bulkAdjustBalance)"
    - from: "src/components/admin/alert-monitor.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "getSuspiciousActivity server action"
      pattern: "getSuspiciousActivity"
---

<objective>
Admin balance management tools (single/bulk adjustments, freeze) and suspicious activity alerts.

Purpose: Per user decisions, admin needs granular balance control with adjustments (single/bulk), wallet freeze capability, and configurable alerts for suspicious patterns. These are the operational tools for managing the virtual economy.

Output: Balance adjustment UI, wallet freeze/unfreeze, suspicious activity alert monitor, all integrated into admin finance page.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-05-SUMMARY.md
@src/lib/actions/admin-finance.ts
@src/app/(app)/admin/finance/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Suspicious activity detection and alert server actions</name>
  <files>src/lib/actions/admin-finance.ts</files>
  <action>
Add to existing `src/lib/actions/admin-finance.ts`:

1. `getSuspiciousActivity()`:
   - requireAdmin()
   - Fetch SystemSettings for alert thresholds (alertTransferLimit, alertBalanceDropPct)
   - Run 3 alert queries in parallel:
     a. **Large transfers**: Transactions of type TRANSFER_SENT in last 24h where amount > alertTransferLimit. Include user displayName.
     b. **Daily transfer limit exceeded**: Group TRANSFER_SENT by userId in last 24h, sum amounts, find where sum > transferDailyLimit. Include user displayName and total.
     c. **Rapid balance drops**: Compare each user's current balance to their balance 1 hour ago (derive from transaction history). Flag where drop > alertBalanceDropPct % of balance. Include user displayName, previous balance, current balance, drop percentage.
   - Return structured alerts array: { type: 'large_transfer' | 'daily_limit' | 'balance_drop', severity: 'warning' | 'critical', userId, displayName, details, timestamp }
   - Sort by timestamp desc

2. `getUsersWithWallets(search?: string)`:
   - requireAdmin()
   - Fetch users with wallet info (balance, frozenAt)
   - If search provided, filter by displayName/username/email containing search
   - Return array for balance adjustment user selection
   - Include: userId, displayName, username, email, balance, frozenAt

3. Update `adjustUserBalance` to also emit balance:updated via a return value pattern:
   - Since this runs in Next.js (not server.js), after adjusting balance, the admin UI can show the updated balance. The actual user will get updated balance on their next socket interaction or page load.
   - Alternative: add a socket event 'admin:balance-adjusted' that the server.js listens for and forwards to the user. For simplicity in this plan, rely on the user's next fetchBalance() call or periodic balance check.
  </action>
  <verify>
`npx tsc --noEmit` passes. Server actions are importable and return expected types.
  </verify>
  <done>Suspicious activity detection queries work for large transfers, daily limits, and rapid balance drops. User search with wallet info supports balance adjustment UI. Alert thresholds configurable via SystemSettings.</done>
</task>

<task type="auto">
  <name>Task 2: Balance adjustment UI, wallet freeze, and alert monitor components</name>
  <files>src/components/admin/balance-adjust.tsx, src/components/admin/alert-monitor.tsx, src/app/(app)/admin/finance/page.tsx</files>
  <action>
Create `src/components/admin/balance-adjust.tsx`:
- 'use client' component

**Single adjustment section:**
- User search input (debounced, calls getUsersWithWallets)
- Dropdown showing matching users with displayName, username, current balance
- On select: show user card with current balance and frozen status
- Amount input (positive = credit, negative = debit) with +/- toggle buttons
- Optional reason textarea
- "Guthaben anpassen" submit button
- Calls adjustUserBalance server action
- Success: toast with new balance, reset form
- Error: toast with error

**Bulk adjustment section:**
- Toggle between "Ausgewaehlte Nutzer" and "Alle Nutzer"
- If selected: multi-select user search (checkboxes next to results)
- If all: warning text "Aenderung wird auf alle Nutzer angewendet"
- Amount input and reason field (same as single)
- "Massenanpassung" submit button with confirmation dialog
- Calls bulkAdjustBalance server action
- Success: toast with count of affected users

**Freeze section (within user card after selection):**
- If user wallet is not frozen: "Guthaben einfrieren" button (amber/warning style)
- If user wallet is frozen: "Guthaben freigeben" button (green)
- Calls freezeWallet/unfreezeWallet server action
- Shows freeze status with timestamp if frozen
- Tooltip explaining: "Eingefrorene Nutzer koennen spielen aber nicht wetten oder ueberweisen"

Create `src/components/admin/alert-monitor.tsx`:
- 'use client' component
- Fetches alerts on mount via getSuspiciousActivity()
- Auto-refresh every 60 seconds
- Display as alert cards:
  - Color coding: warning (amber border), critical (red border)
  - Icon: ExclamationTriangle for warnings, Shield for critical
  - Content: alert type label in German, user displayName, details, timestamp
  - Alert type labels:
    - large_transfer: "Grosse Ueberweisung"
    - daily_limit: "Tageslimit ueberschritten"
    - balance_drop: "Schneller Guthaben-Verlust"
- If no alerts: green status card "Keine verdaechtigen Aktivitaeten"
- Compact list format, scrollable if many

Update `src/app/(app)/admin/finance/page.tsx`:
- Add two more tab sections:
  - "Guthaben" tab: BalanceAdjust component
  - "Alarme" tab: AlertMonitor component
- So total tabs are: Dashboard | Transaktionen | Guthaben | Alarme | Einstellungen
- Pass initial alert count to tab label: "Alarme ({count})" with red badge if count > 0
  </action>
  <verify>
`npx tsc --noEmit` passes. Navigate to /admin/finance. Switch to "Guthaben" tab, search for a user, adjust their balance. Switch to "Alarme" tab, verify it loads (may show "Keine verdaechtigen Aktivitaeten"). Freeze a user, verify frozen status shows.
  </verify>
  <done>Admin can adjust single user balance with reason. Bulk adjustments work for selected or all users. Wallet freeze/unfreeze functional. Suspicious activity alerts display in dedicated tab. All operations logged.</done>
</task>

</tasks>

<verification>
- Admin can search users and adjust balance (positive and negative)
- Balance adjustment shows in user's transaction history
- Bulk adjustment applies to multiple users
- Wallet freeze prevents outbound operations for that user
- Alert monitor shows suspicious activity (test by creating a large transfer)
- Alert monitor shows "no alerts" when clean
- All admin finance tabs load and function
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Admin has full balance management: single adjustments with reason, bulk adjustments, wallet freeze/unfreeze. Suspicious activity alerts detect large transfers, daily limit violations, and rapid balance drops. All configurable via SystemSettings thresholds.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-09-SUMMARY.md`
</output>
